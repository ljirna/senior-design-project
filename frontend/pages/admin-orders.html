<!-- ================= ADMIN ORDERS MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header with Back Button -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>Orders</h1>
        <p>Manage all customer orders</p>
      </div>
      <button
        class="table-action-btn secondary"
        onclick="window.location.hash='admin-dashboard'"
      >
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </div>

  <!-- Loading indicator -->
  <div id="orders-loading" style="text-align: center; padding: 2rem">
    <p>Loading orders...</p>
  </div>

  <!-- No orders message -->
  <div
    id="orders-empty"
    style="text-align: center; padding: 2rem; display: none"
  >
    <p>No orders found.</p>
  </div>

  <!-- Orders List -->
  <div class="row" id="orders-list">
    <!-- Order cards will be loaded dynamically from API -->
  </div>
</main>

<script>
  var allOrders = [];
  var filteredOrders = [];

  // Initialize if DOM is already loaded (happens when injected into existing page)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAdminOrdersPage);
  } else {
    // DOM already loaded - page was dynamically injected
    // Initialize after a small delay to ensure elements are in DOM
    setTimeout(() => {
      initAdminOrdersPage();
    }, 100);
  }

  function initAdminOrdersPage() {
    loadOrders();
  }

  // Load all orders from API
  function loadOrders() {
    const token = localStorage.getItem("user_token");
    if (!token) {
      showToast("Session expired. Please login again.", "error");
      return;
    }

    const loadingDiv = document.getElementById("orders-loading");
    const emptyDiv = document.getElementById("orders-empty");
    const ordersList = document.getElementById("orders-list");

    loadingDiv.style.display = "block";
    emptyDiv.style.display = "none";
    ordersList.innerHTML = "";

    fetch(Constants.get_api_base_url() + "orders?limit=100", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (!data) return;
        allOrders = Array.isArray(data) ? data : data.data || [];

        loadingDiv.style.display = "none";

        if (allOrders.length === 0) {
          emptyDiv.style.display = "block";
          return;
        }

        filteredOrders = allOrders;
        renderOrders(allOrders);
      })
      .catch((error) => {
        console.error("Error loading orders:", error);
        loadingDiv.style.display = "none";
        showToast("Error loading orders. Please try again.", "error");
      });
  }

  // Render orders in the grid
  function renderOrders(orders) {
    const ordersList = document.getElementById("orders-list");
    ordersList.innerHTML = "";

    orders.forEach((order) => {
      const orderCard = createOrderCard(order);
      ordersList.appendChild(orderCard);
    });
  }

  // Create an order card element
  function createOrderCard(order) {
    const col = document.createElement("div");
    col.className = "col-lg-6 mb-4";

    const orderDate = order.order_date
      ? new Date(order.order_date).toLocaleDateString()
      : "N/A";
    const orderTime = order.order_date
      ? new Date(order.order_date).toLocaleTimeString()
      : "";
    const statusClass =
      order.status === "pending" ? "status-pending" : "status-delivered";
    const statusText = order.status === "pending" ? "Pending" : "Approved";

    col.innerHTML = `
      <div class="order-card-admin">
        <div class="order-header-admin">
          <div>
            <h3>#ORD-${String(order.order_id).padStart(5, "0")}</h3>
            <p class="order-date">${orderDate} â€¢ ${orderTime}</p>
          </div>
          <span class="status-badge ${statusClass}">${statusText}</span>
        </div>

        <div class="order-customer-admin">
          <div class="customer-info">
            <i class="fas fa-user"></i>
            <div>
              <strong>${order.customer_name || "N/A"}</strong>
              <p>${order.customer_email || "N/A"}</p>
            </div>
          </div>
          ${
            order.customer_phone
              ? `<div class="customer-contact">
              <i class="fas fa-phone"></i> ${order.customer_phone}
            </div>`
              : ""
          }
        </div>

        <div class="order-summary-admin">
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>${
              order.subtotal ? parseFloat(order.subtotal).toFixed(2) : "0.00"
            } KM</span>
          </div>
          ${
            order.delivery_fee
              ? `<div class="summary-row">
            <span>Delivery:</span>
            <span>${parseFloat(order.delivery_fee).toFixed(2)} KM</span>
          </div>`
              : ""
          }
          ${
            order.assembly_fee
              ? `<div class="summary-row">
            <span>Assembly:</span>
            <span>${parseFloat(order.assembly_fee).toFixed(2)} KM</span>
          </div>`
              : ""
          }
          <div class="summary-row total">
            <strong>Total:</strong>
            <strong>${
              order.total_amount
                ? parseFloat(order.total_amount).toFixed(2)
                : "0.00"
            } KM</strong>
          </div>
        </div>

        <div class="order-actions-admin">
          <button class="table-action-btn secondary" onclick="viewOrderDetails(${
            order.order_id
          })">
            <i class="fas fa-eye"></i> View Details
          </button>
        </div>
      </div>
    `;

    return col;
  }

  // View order details
  function viewOrderDetails(orderId) {
    window.location.hash = `admin-order-detail/${orderId}`;
  }
</script>

<style>
  /* Order Card Styles */
  .order-card-admin {
    background: white;
    border-radius: 8px;
    border: 1px solid var(--creme-dark);
    box-shadow: 0 2px 10px rgba(62, 39, 35, 0.1);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .order-card-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 20px rgba(62, 39, 35, 0.15);
  }

  .order-header-admin {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.5rem 1.5rem 1rem;
    border-bottom: 1px solid var(--creme-dark);
  }

  .order-header-admin h3 {
    color: var(--burgundy-primary);
    margin: 0;
  }

  .order-date {
    color: var(--medium-brown);
    font-size: 0.9rem;
    margin: 0.3rem 0 0;
  }

  .order-customer-admin {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--creme-dark);
  }

  .customer-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
  }

  .customer-info i {
    color: var(--burgundy-light);
    font-size: 1.2rem;
  }

  .customer-info strong {
    color: var(--burgundy-primary);
    display: block;
  }

  .customer-info p {
    color: var(--medium-brown);
    margin: 0;
    font-size: 0.9rem;
  }

  .customer-contact {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--medium-brown);
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }

  .customer-contact i {
    color: var(--burgundy-light);
  }

  .order-summary-admin {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--creme-dark);
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
  }

  .summary-row.total {
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid var(--creme-dark);
    color: var(--burgundy-primary);
    font-size: 1.1rem;
  }

  .order-actions-admin {
    padding: 1rem 1.5rem;
    display: flex;
    gap: 0.5rem;
  }

  .order-actions-admin .table-action-btn {
    flex: 1;
    text-align: center;
  }

  /* Status Badges */
  .status-badge {
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
    text-transform: capitalize;
  }

  .status-pending {
    background-color: rgba(243, 156, 18, 0.1);
    color: #f39c12;
  }

  .status-delivered {
    background-color: rgba(40, 167, 69, 0.1);
    color: #28a745;
  }

  .status-cancelled {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
  }

  /* Grid Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .row {
      grid-template-columns: 1fr;
    }

    .section-header > div {
      flex-direction: column;
      gap: 1rem;
    }
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }
</style>
