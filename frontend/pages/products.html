<main class="page-container">
  <div class="container">
    <h1>Our Products</h1>

    <!-- Products Search Bar -->
    <div class="products-search-container">
      <input
        type="text"
        id="products-search-input"
        class="products-search-input"
        placeholder="Search products by name, category..."
        aria-label="Search products"
      />
      <button
        id="products-search-btn"
        class="products-search-btn"
        aria-label="Search products"
      >
        <i class="fas fa-search"></i> Search
      </button>
    </div>

    <!-- Category Filter Section -->
    <!-- Moved to header navigation dropdown -->

    <!-- Products Grid -->
    <div
      class="products-grid"
      id="products-content"
      style="
        min-height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
      "
    >
      <p style="color: var(--medium-brown)">Loading products...</p>
    </div>
  </div>
</main>

<script>
  if (!window.productsPageState) {
    window.productsPageState = {
      allProducts: [],
      allCategories: [],
      selectedCategoryId: "",
    };
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      initProductsPage();
    });
  } else {
    setTimeout(() => {
      initProductsPage();
    }, 100);
  }

  // Listen for hash changes to update category filter
  window.addEventListener("hashchange", function () {
    const hash = window.location.hash;
    const hashParams = new URLSearchParams(hash.split("?")[1]);
    const categoryParam = hashParams.get("category");

    if (categoryParam) {
      window.productsPageState.selectedCategoryId = categoryParam;
      loadProductsByCategory(categoryParam);
    } else {
      window.productsPageState.selectedCategoryId = "";
      loadCategoriesAndProducts();
    }
  });

  function initProductsPage() {
    const container = document.getElementById("products-content");
    if (!container) return;

    // Check URL hash for category parameter (hash-based routing)
    const hash = window.location.hash;
    const hashParams = new URLSearchParams(hash.split("?")[1]);
    const categoryParam = hashParams.get("category");

    setupSearchListeners();

    if (categoryParam) {
      window.productsPageState.selectedCategoryId = categoryParam;
      loadProductsByCategory(categoryParam);
    } else {
      loadCategoriesAndProducts();
    }
  }

  function loadCategoriesAndProducts() {
    CategoryService.getAll(
      (categories) => {
        window.productsPageState.allCategories = Array.isArray(categories)
          ? categories
          : categories.data || [];
      },
      (error) => {
        console.error("Error loading categories:", error);
      }
    );

    ProductService.getAll(
      null,
      null,
      (products) => {
        window.productsPageState.allProducts = Array.isArray(products)
          ? products
          : products.data || [];

        renderProducts();
      },
      (error) => {
        console.error("Error loading products:", error);
      }
    );
  }

  function loadProductsByCategory(categoryId) {
    CategoryService.getAll(
      (categories) => {
        window.productsPageState.allCategories = Array.isArray(categories)
          ? categories
          : categories.data || [];
      },
      (error) => {
        console.error("Error loading categories:", error);
      }
    );

    ProductService.getByCategory(
      categoryId,
      null,
      null,
      (products) => {
        window.productsPageState.allProducts = Array.isArray(products)
          ? products
          : products.data || [];

        renderProducts();
      },
      (error) => {
        console.error("Error loading products by category:", error);
      }
    );
  }

  function renderProducts() {
    const container = document.getElementById("products-content");
    if (!container) return;

    const products = window.productsPageState.allProducts;

    if (products.length === 0) {
      container.innerHTML =
        '<div style="text-align: center; padding: 3rem; grid-column: 1 / -1"><p style="color: var(--medium-brown); font-size: 1.1rem">No products found</p></div>';
      return;
    }

    container.innerHTML = "";
    container.style.display = "grid";

    products.forEach((product) => {
      const card = createProductCard(product);
      container.appendChild(card);
    });

    setupFavoriteButtons();
  }

  function createProductCard(product) {
    const card = document.createElement("div");
    card.className = "product-card";

    const categoryName =
      window.productsPageState.allCategories.find(
        (c) =>
          c.category_id == product.category_id || c.id == product.category_id
      )?.name || "Uncategorized";

    const primaryImage =
      product.images && product.images.length > 0
        ? product.images[0].image_url
        : "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect fill='%23e0e0e0' width='300' height='300'/%3E%3Ctext x='50%25' y='50%25' font-size='16' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E";

    card.innerHTML = `
      <button class="favorite-btn" data-product-id="${
        product.product_id || product.id
      }" aria-label="Add to favorites">
        <i class="far fa-heart"></i>
      </button>
      <img
        src="${primaryImage}"
        alt="${product.name}"
        class="product-image"
      />
      <div class="product-content">
        <h3 class="product-title">${product.name}</h3>
        <p class="product-category">${categoryName}</p>
        <div class="product-price">$${parseFloat(product.price).toFixed(
          2
        )}</div>
        <div class="product-actions">
          <a href="#single-product/${
            product.product_id || product.id
          }" class="btn-see-more">See More</a>
        </div>
      </div>
    `;

    return card;
  }

  function setupFavoriteButtons() {
    document.querySelectorAll(".favorite-btn").forEach((btn) => {
      btn.removeEventListener("click", handleFavoriteClick);
      btn.addEventListener("click", handleFavoriteClick);
    });
  }

  function handleFavoriteClick(e) {
    e.preventDefault();
    const icon = this.querySelector("i");
    const productId = this.getAttribute("data-product-id");

    if (icon.classList.contains("far")) {
      FavoriteService.addToFavorites(
        productId,
        (response) => {
          icon.classList.remove("far");
          icon.classList.add("fas");
          if (typeof showToast === "function") {
            showToast("Added to favorites!", "success");
          }
        },
        (error) => {
          if (typeof showToast === "function") {
            showToast("Failed to add to favorites", "error");
          }
          console.error("Error adding to favorites:", error);
        }
      );
    } else {
      FavoriteService.removeFromFavorites(
        productId,
        (response) => {
          icon.classList.remove("fas");
          icon.classList.add("far");
          if (typeof showToast === "function") {
            showToast("Removed from favorites!", "info");
          }
        },
        (error) => {
          if (typeof showToast === "function") {
            showToast("Failed to remove from favorites", "error");
          }
          console.error("Error removing from favorites:", error);
        }
      );
    }
  }

  // Setup search when the page initializes
  function setupSearchListeners() {
    const searchBtn = document.getElementById("products-search-btn");
    const searchInput = document.getElementById("products-search-input");

    if (searchBtn && searchInput) {
      // Remove any existing listeners by cloning
      const newSearchBtn = searchBtn.cloneNode(true);
      if (searchBtn.parentNode) {
        searchBtn.parentNode.replaceChild(newSearchBtn, searchBtn);
      }

      const newSearchInput = searchInput.cloneNode(true);
      if (searchInput.parentNode) {
        searchInput.parentNode.replaceChild(newSearchInput, searchInput);
      }

      // Add new listeners
      newSearchBtn.addEventListener("click", performSearch);
      newSearchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          performSearch();
        }
      });
    }
  }

  function performSearch() {
    const searchTerm = document
      .getElementById("products-search-input")
      .value.trim();
    if (!searchTerm) {
      renderProducts();
      return;
    }

    ProductService.searchProducts(
      searchTerm,
      null,
      null,
      (products) => {
        window.productsPageState.allProducts = Array.isArray(products)
          ? products
          : products.data || [];

        window.productsPageState.selectedCategoryId = "";
        document.querySelectorAll(".category-btn").forEach((b) => {
          b.classList.remove("active");
        });
        const allCategoriesBtn = document.querySelector(
          "[data-category-id='']"
        );
        if (allCategoriesBtn) {
          allCategoriesBtn.classList.add("active");
        }

        renderProducts();
      },
      (error) => {
        console.error("Error searching products:", error);
      }
    );
  }
</script>
