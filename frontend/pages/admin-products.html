<!-- ================= ADMIN PRODUCTS MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>Products</h1>
        <p>Manage All Products</p>
      </div>
      <button
        class="table-action-btn secondary"
        onclick="window.location.hash='admin-dashboard'"
      >
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </div>

  <!-- Filters and Search -->
  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 1rem;
      margin-bottom: 2rem;
    "
  >
    <!-- Search -->
    <div>
      <label
        style="
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 600;
          color: var(--medium-brown);
        "
        >Search Products</label
      >
      <input
        type="text"
        id="product-search"
        placeholder="Search by name..."
        style="
          width: 100%;
          padding: 0.8rem;
          border: 1px solid var(--creme-dark);
          border-radius: 4px;
        "
      />
    </div>

    <!-- Category Filter -->
    <div>
      <label
        style="
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 600;
          color: var(--medium-brown);
        "
        >Category</label
      >
      <select
        id="category-filter"
        style="
          width: 100%;
          padding: 0.8rem;
          border: 1px solid var(--creme-dark);
          border-radius: 4px;
        "
      >
        <option value="">All Categories</option>
      </select>
    </div>

    <!-- Add Product Button -->
    <button
      id="add-product-btn"
      style="
        background-color: #28a745;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        align-self: flex-end;
        font-weight: 600;
      "
    >
      <i class="fas fa-plus"></i> Add Product
    </button>
  </div>

  <!-- Results Info -->
  <div style="margin-bottom: 1rem; color: var(--medium-brown)">
    <p>Showing <strong id="product-count">0</strong> products</p>
  </div>

  <!-- Products Grid -->
  <div class="row" id="products-grid"></div>

  <!-- Empty State -->
  <div
    id="products-empty"
    style="text-align: center; padding: 3rem; display: none"
  >
    <i
      class="fas fa-inbox"
      style="font-size: 3rem; color: var(--creme-dark); margin-bottom: 1rem"
    ></i>
    <p style="color: var(--medium-brown); font-size: 1.1rem">
      No products found
    </p>
  </div>

  <!-- Loading State -->
  <div id="products-loading" style="text-align: center; padding: 3rem">
    <div class="spinner" style="margin: 0 auto"></div>
    <p style="color: var(--medium-brown); margin-top: 1rem">
      Loading products...
    </p>
  </div>
</main>

<!-- Add Product Modal -->
<div class="admin-modal-overlay" id="addProductModal">
  <div
    class="admin-modal"
    style="max-width: 600px; max-height: 90vh; overflow-y: auto"
  >
    <div class="modal-header">
      <h3>Add New Product</h3>
      <button class="modal-close" onclick="closeModal('addProductModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="add-product-form">
        <div class="form-group">
          <label for="add_product_name">Product Name *</label>
          <input
            type="text"
            class="form-input"
            id="add_product_name"
            required
          />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="add_product_category">Category *</label>
            <select class="form-input" id="add_product_category" required>
              <option value="">Select Category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="add_product_price">Price ($) *</label>
            <input
              type="number"
              class="form-input"
              id="add_product_price"
              step="0.01"
              min="0"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="add_product_description">Description</label>
          <textarea
            class="form-input"
            id="add_product_description"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="add_product_dimensions"
            >Dimensions (W x H x D in cm)</label
          >
          <input
            type="text"
            class="form-input"
            id="add_product_dimensions"
            placeholder="e.g., 100 x 200 x 50"
          />
        </div>

        <div class="form-group">
          <label for="add_product_weight">Weight (kg)</label>
          <input
            type="number"
            class="form-input"
            id="add_product_weight"
            step="0.1"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_delivery_fee"
            >Delivery Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="add_product_delivery_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_assembly_fee"
            >Assembly Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="add_product_assembly_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_image">Product Image</label>
          <div style="margin-bottom: 1rem">
            <img
              id="add_product_image_preview"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E"
              alt="Product preview"
              style="max-width: 200px; max-height: 200px; border-radius: 4px"
            />
          </div>
          <input
            type="file"
            class="form-input"
            id="add_product_image"
            accept="image/*"
            required
          />
          <small style="color: var(--medium-brown)"
            >JPG, PNG, GIF, WebP up to 5MB</small
          >
        </div>

        <button
          type="submit"
          class="table-action-btn"
          style="
            width: 100%;
            margin-top: 1rem;
            background-color: #28a745;
            color: white;
          "
        >
          <i class="fas fa-plus"></i> Add Product
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="admin-modal-overlay" id="editProductModal">
  <div
    class="admin-modal"
    style="max-width: 600px; max-height: 90vh; overflow-y: auto"
  >
    <div class="modal-header">
      <h3>Edit Product</h3>
      <button class="modal-close" onclick="closeModal('editProductModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="edit-product-form">
        <input type="hidden" id="edit_product_id" />

        <div class="form-group">
          <label for="edit_product_name">Product Name *</label>
          <input
            type="text"
            class="form-input"
            id="edit_product_name"
            required
          />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="edit_product_category">Category *</label>
            <select class="form-input" id="edit_product_category" required>
              <option value="">Select Category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit_product_price">Price ($) *</label>
            <input
              type="number"
              class="form-input"
              id="edit_product_price"
              step="0.01"
              min="0"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="edit_product_description">Description</label>
          <textarea
            class="form-input"
            id="edit_product_description"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="edit_product_dimensions"
            >Dimensions (W x H x D in cm)</label
          >
          <input
            type="text"
            class="form-input"
            id="edit_product_dimensions"
            placeholder="e.g., 100 x 200 x 50"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_weight">Weight (kg)</label>
          <input
            type="number"
            class="form-input"
            id="edit_product_weight"
            step="0.1"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_delivery_fee"
            >Delivery Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="edit_product_delivery_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_assembly_fee"
            >Assembly Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="edit_product_assembly_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_image">Product Image</label>
          <div style="margin-bottom: 1rem">
            <img
              id="edit_product_image_preview"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E"
              alt="Product preview"
              style="max-width: 200px; max-height: 200px; border-radius: 4px"
            />
          </div>
          <input
            type="file"
            class="form-input"
            id="edit_product_image"
            accept="image/*"
          />
          <small style="color: var(--medium-brown)"
            >JPG, PNG, GIF, WebP up to 5MB</small
          >
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
          <button type="submit" class="table-action-btn" style="flex: 1">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button
            type="button"
            class="table-action-btn secondary"
            onclick="deleteProductConfirm()"
            style="flex: 1"
          >
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  let allProducts = [];
  let allCategories = [];
  let filteredProducts = [];

  // Initialize if DOM is already loaded (happens when injected into existing page)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      initAdminProducts_Page();
    });
  } else {
    // DOM already loaded - page was dynamically injected
    // Initialize after a small delay to ensure elements are in DOM
    setTimeout(() => {
      initAdminProducts_Page();
    }, 100);
  }

  // This function is called both by DOMContentLoaded and by router
  function initAdminProducts_Page() {
    // Check if required elements exist
    const requiredElements = [
      "products-loading",
      "products-grid",
      "product-search",
      "category-filter",
      "add-product-btn",
    ];

    const missingElements = requiredElements.filter(
      (id) => !document.getElementById(id)
    );
    if (missingElements.length > 0) {
      console.error("[AdminProducts] Missing elements:", missingElements);
      return;
    }

    // Load categories FIRST, then products, then setup listeners
    loadCategoriesAndThenProducts();
    setupEventListeners();
  }

  // Load categories first, then load products after categories are ready
  function loadCategoriesAndThenProducts() {
    const token = localStorage.getItem("user_token");

    if (!token) {
      console.error("[AdminProducts] No token");
      return;
    }

    // Load categories
    fetch("http://localhost/diplomski/backend/categories", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        allCategories = Array.isArray(data) ? data : data.data || [];

        // Populate category selects
        const categorySelects = [
          "add_product_category",
          "edit_product_category",
        ];
        categorySelects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;
          // Clear existing options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }
          allCategories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.category_id || cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
          });
        });

        // Populate filter
        const filterSelect = document.getElementById("category-filter");
        if (filterSelect) {
          // Clear existing options except the first one
          while (filterSelect.options.length > 1) {
            filterSelect.remove(1);
          }
          allCategories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.category_id || cat.id;
            option.textContent = cat.name;
            filterSelect.appendChild(option);
          });
        }

        // NOW load products after categories are ready
        loadProducts();
      })
      .catch((error) => {
        console.error("[AdminProducts] Error loading categories:", error);
        loadProducts(); // Still load products even if categories fail
      });
  }

  // Make it global so router can call it
  window.initAdminProducts_Page = initAdminProducts_Page;

  function setupEventListeners() {
    document
      .getElementById("add-product-btn")
      .addEventListener("click", function () {
        document.getElementById("add-product-form").reset();
        document.getElementById("add_product_image_preview").src =
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E";
        openModal("addProductModal");
      });

    document
      .getElementById("add-product-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        addProduct();
      });

    document
      .getElementById("edit-product-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        saveProduct();
      });

    document
      .getElementById("add_product_image")
      .addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            document.getElementById("add_product_image_preview").src =
              event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

    document
      .getElementById("product-search")
      .addEventListener("input", applyFilters);
    document
      .getElementById("category-filter")
      .addEventListener("change", applyFilters);

    // Add image preview for edit form
    document
      .getElementById("edit_product_image")
      .addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            document.getElementById("edit_product_image_preview").src =
              event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
  }

  function loadProducts() {
    const token = localStorage.getItem("user_token");
    const loadingDiv = document.getElementById("products-loading");
    const emptyDiv = document.getElementById("products-empty");
    const grid = document.getElementById("products-grid");

    if (!loadingDiv) {
      console.error("[AdminProducts] loadingDiv not found!");
      return;
    }

    if (!token) {
      console.error("[AdminProducts] No token found in localStorage");
      loadingDiv.style.display = "none";
      showToast("Session expired. Please login again.", "error");
      window.location.hash = "#login";
      return;
    }

    loadingDiv.style.display = "block";
    if (emptyDiv) emptyDiv.style.display = "none";
    if (grid) grid.innerHTML = "";

    const apiUrl = "http://localhost/diplomski/backend/products?limit=100";

    fetch(apiUrl, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          console.error(
            "[AdminProducts] 401 Unauthorized - token may be invalid"
          );
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }

        if (!response.ok) {
          console.error(
            "[AdminProducts] Non-OK status:",
            response.status,
            response.statusText
          );
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      })
      .then((data) => {
        if (!data) {
          loadingDiv.style.display = "none";
          return;
        }

        // Handle both array response and {data: [...]} response format
        if (Array.isArray(data)) {
          allProducts = data;
        } else if (data.data && Array.isArray(data.data)) {
          allProducts = data.data;
        } else {
          allProducts = [];
        }

        filteredProducts = [...allProducts];

        loadingDiv.style.display = "none";
        renderProducts();
      })
      .catch((error) => {
        console.error("[AdminProducts] Error loading products:", error);
        console.error("[AdminProducts] Error stack:", error.stack);
        loadingDiv.style.display = "none";
        if (emptyDiv) {
          emptyDiv.style.display = "block";
          emptyDiv.innerHTML = `<p>Error loading products: ${error.message}</p>`;
        }
        showToast("Error loading products: " + error.message, "error");
      });
  }

  function applyFilters() {
    const searchTerm = document
      .getElementById("product-search")
      .value.toLowerCase();
    const categoryId = document.getElementById("category-filter").value;

    filteredProducts = allProducts.filter((product) => {
      if (searchTerm && !product.name.toLowerCase().includes(searchTerm)) {
        return false;
      }

      if (categoryId && product.category_id != categoryId) {
        return false;
      }

      return true;
    });

    renderProducts();
  }

  function renderProducts() {
    const grid = document.getElementById("products-grid");
    const emptyDiv = document.getElementById("products-empty");
    const countDiv = document.getElementById("product-count");

    if (!grid) {
      console.error("[AdminProducts] products-grid element not found!");
      return;
    }

    grid.innerHTML = "";
    if (countDiv) countDiv.textContent = filteredProducts.length;

    if (filteredProducts.length === 0) {
      if (emptyDiv) emptyDiv.style.display = "block";
      grid.style.display = "none";
      return;
    }

    if (emptyDiv) emptyDiv.style.display = "none";
    grid.style.display = "grid";
    filteredProducts.forEach((product, index) => {
      try {
        const col = document.createElement("div");
        col.className = "col-lg-4 col-md-6 mb-4";
        col.innerHTML = `
          <div class="product-card-admin">
            <img src="${
              product.image_url ||
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect fill='%23e0e0e0' width='300' height='300'/%3E%3Ctext x='50%25' y='50%25' font-size='16' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E"
            }" alt="${product.name}" class="product-image-admin" />
            <div class="product-content-admin">
              <h3 class="product-title-admin">${product.name}</h3>
              <p class="product-category-admin">${getCategoryName(
                product.category_id
              )}</p>
              <div class="product-price-admin">$${parseFloat(
                product.price
              ).toFixed(2)}</div>
              <div class="product-actions-admin">
                <button class="table-action-btn" onclick="editProduct(${
                  product.product_id
                })" style="flex: 1">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="table-action-btn secondary" onclick="deleteProductConfirm(${
                  product.product_id
                })" style="flex: 1">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(col);
      } catch (error) {
        console.error(
          "[AdminProducts] Error rendering product at index",
          index,
          ":",
          error,
          "Product:",
          product
        );
      }
    });
  }

  function getCategoryName(categoryId) {
    if (!categoryId) return "Uncategorized";

    const category = allCategories.find((c) => {
      // Check both category_id and id fields
      return c.category_id == categoryId || c.id == categoryId;
    });

    return category ? category.name : "Uncategorized";
  }

  function editProduct(productId) {
    const product = allProducts.find((p) => p.product_id == productId);
    if (!product) {
      showToast("Product not found", "error");
      return;
    }

    document.getElementById("edit_product_id").value = productId;
    document.getElementById("edit_product_name").value = product.name || "";
    document.getElementById("edit_product_category").value =
      product.category_id || "";
    document.getElementById("edit_product_price").value = product.price || "";
    document.getElementById("edit_product_description").value =
      product.description || "";
    document.getElementById("edit_product_dimensions").value =
      product.width_cm && product.height_cm && product.depth_cm
        ? `${product.width_cm} x ${product.height_cm} x ${product.depth_cm}`
        : "";
    document.getElementById("edit_product_weight").value =
      product.weight_kg || "";
    document.getElementById("edit_product_delivery_fee").value =
      product.delivery_fee_override || "";
    document.getElementById("edit_product_assembly_fee").value =
      product.assembly_fee_override || "";

    // Set image preview
    const imagePreview = document.getElementById("edit_product_image_preview");
    if (product.image_url) {
      imagePreview.src = product.image_url;
    } else {
      imagePreview.src =
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E";
    }

    // Clear the file input
    document.getElementById("edit_product_image").value = "";

    openModal("editProductModal");
  }

  function addProduct() {
    const name = document.getElementById("add_product_name").value.trim();
    const categoryId = document.getElementById("add_product_category").value;
    const price = document.getElementById("add_product_price").value;
    const description = document
      .getElementById("add_product_description")
      .value.trim();
    const dimensions = document
      .getElementById("add_product_dimensions")
      .value.trim();
    const weight = document.getElementById("add_product_weight").value || null;
    const deliveryFee =
      document.getElementById("add_product_delivery_fee").value || null;
    const assemblyFee =
      document.getElementById("add_product_assembly_fee").value || null;
    const imageFile = document.getElementById("add_product_image").files[0];

    if (!name || !categoryId || !price) {
      showToast("Please fill in all required fields", "error");
      return;
    }

    if (!imageFile) {
      showToast("Please select a product image", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    // Upload image first
    uploadProductImage(imageFile, token, function (imageUrl) {
      // After image upload, create the product with the image URL
      createProductData(
        name,
        categoryId,
        price,
        description,
        dimensions,
        weight,
        deliveryFee,
        assemblyFee,
        imageUrl,
        token
      );
    });
  }

  function createProductData(
    name,
    categoryId,
    price,
    description,
    dimensions,
    weight,
    deliveryFee,
    assemblyFee,
    imageUrl,
    token
  ) {
    // Parse dimensions
    let width, height, depth;
    if (dimensions) {
      const parts = dimensions.split("x").map((p) => parseFloat(p.trim()));
      width = parts[0] || null;
      height = parts[1] || null;
      depth = parts[2] || null;
    }

    const productData = {
      name: name,
      category_id: categoryId,
      price: price,
      description: description,
      width_cm: width,
      height_cm: height,
      depth_cm: depth,
      weight_kg: weight,
      delivery_fee_override: deliveryFee,
      assembly_fee_override: assemblyFee,
      image_url: imageUrl,
    };

    showToast("Adding product...", "info");

    fetch("http://localhost/diplomski/backend/products", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(productData),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error adding product");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Product added successfully!", "success");
        closeModal("addProductModal");
        // Reset form
        document.getElementById("add-product-form").reset();
        document.getElementById("add_product_image_preview").src =
          "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E";
        loadProducts();
      })
      .catch((error) => {
        console.error("Error adding product:", error);
        showToast(error.message || "Error adding product.", "error");
      });
  }

  function saveProduct() {
    const productId = document.getElementById("edit_product_id").value;
    const name = document.getElementById("edit_product_name").value.trim();
    const categoryId = document.getElementById("edit_product_category").value;
    const price = document.getElementById("edit_product_price").value;
    const description = document
      .getElementById("edit_product_description")
      .value.trim();
    const dimensions = document
      .getElementById("edit_product_dimensions")
      .value.trim();
    const weight = document.getElementById("edit_product_weight").value || null;
    const deliveryFee =
      document.getElementById("edit_product_delivery_fee").value || null;
    const assemblyFee =
      document.getElementById("edit_product_assembly_fee").value || null;
    const imageFile = document.getElementById("edit_product_image").files[0];

    if (!name || !categoryId || !price) {
      showToast("Please fill in all required fields", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    // If there's an image file to upload, upload it first
    if (imageFile) {
      uploadProductImage(imageFile, token, function (imageUrl) {
        // After image upload, update the product with the image URL
        updateProductData(
          productId,
          name,
          categoryId,
          price,
          description,
          dimensions,
          weight,
          deliveryFee,
          assemblyFee,
          imageUrl,
          token
        );
      });
    } else {
      // No image to upload, just update the product
      updateProductData(
        productId,
        name,
        categoryId,
        price,
        description,
        dimensions,
        weight,
        deliveryFee,
        assemblyFee,
        null,
        token
      );
    }
  }

  function uploadProductImage(file, token, callback) {
    const formData = new FormData();
    formData.append("itemImage", file);

    fetch("http://localhost/diplomski/backend/api/upload/item-image/", {
      method: "POST",
      headers: {
        Authentication: token,
      },
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          callback("assets/img/products/" + data.filename);
        } else {
          throw new Error(data.message || "Image upload failed");
        }
      })
      .catch((error) => {
        console.error("Error uploading image:", error);
        showToast("Error uploading image: " + error.message, "error");
      });
  }

  function updateProductData(
    productId,
    name,
    categoryId,
    price,
    description,
    dimensions,
    weight,
    deliveryFee,
    assemblyFee,
    imageUrl,
    token
  ) {
    // Parse dimensions
    let width, height, depth;
    if (dimensions) {
      const parts = dimensions.split("x").map((p) => parseFloat(p.trim()));
      width = parts[0] || null;
      height = parts[1] || null;
      depth = parts[2] || null;
    }

    const productData = {
      name: name,
      category_id: categoryId,
      price: price,
      description: description,
      width_cm: width,
      height_cm: height,
      depth_cm: depth,
      weight_kg: weight,
      delivery_fee_override: deliveryFee,
      assembly_fee_override: assemblyFee,
    };

    // Add image URL only if it was provided
    if (imageUrl) {
      productData.image_url = imageUrl;
    }

    showToast("Updating product...", "info");

    fetch(`http://localhost/diplomski/backend/products/${productId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(productData),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error updating product");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Product updated successfully!", "success");
        closeModal("editProductModal");
        loadProducts();
      })
      .catch((error) => {
        console.error("Error updating product:", error);
        showToast(error.message || "Error updating product.", "error");
      });
  }

  function deleteProductConfirm(productId = null) {
    const id = productId || document.getElementById("edit_product_id").value;
    const product = allProducts.find((p) => p.id == id);

    if (!product) {
      showToast("Product not found", "error");
      return;
    }

    if (
      confirm(
        `Are you sure you want to delete "${product.name}"? This action cannot be undone.`
      )
    ) {
      deleteProduct(id);
    }
  }

  function deleteProduct(productId) {
    const token = localStorage.getItem("user_token");

    showToast("Deleting product...", "info");

    fetch(`http://localhost/diplomski/backend/products/${productId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error deleting product");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Product deleted successfully!", "success");
        closeModal("editProductModal");
        loadProducts();
      })
      .catch((error) => {
        console.error("Error deleting product:", error);
        showToast(error.message || "Error deleting product.", "error");
      });
  }

  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add("active");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
    }
  }
</script>

<style>
  .product-card-admin {
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(62, 39, 35, 0.1);
    transition: all 0.3s ease;
    border: 1px solid var(--creme-dark);
  }

  .product-card-admin:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(62, 39, 35, 0.15);
  }

  .product-image-admin {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .product-content-admin {
    padding: 1.5rem;
  }

  .product-title-admin {
    color: var(--burgundy-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .product-category-admin {
    color: var(--medium-brown);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .product-price-admin {
    color: var(--burgundy-dark);
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }

  .product-meta-admin {
    display: flex;
    justify-content: space-between;
    color: var(--medium-brown);
    font-size: 0.85rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--creme-dark);
  }

  .product-meta-admin span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .product-actions-admin {
    display: flex;
    gap: 0.5rem;
  }

  .product-actions-admin .table-action-btn {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
    font-family: inherit;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }

  .form-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .row {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }

    .form-row-2 {
      grid-template-columns: 1fr;
    }
  }
</style>
