<!-- ================= ADMIN PRODUCTS MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>Products</h1>
        <p>Manage All Products</p>
      </div>
      <button
        class="table-action-btn secondary"
        onclick="window.location.hash='admin-dashboard'"
      >
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </div>

  <!-- Filters and Search -->
  <div
    style="
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 1rem;
      margin-bottom: 2rem;
    "
  >
    <!-- Search -->
    <div>
      <label
        style="
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 600;
          color: var(--medium-brown);
        "
        >Search Products</label
      >
      <input
        type="text"
        id="product-search"
        placeholder="Search by name..."
        style="
          width: 100%;
          padding: 0.8rem;
          border: 1px solid var(--creme-dark);
          border-radius: 4px;
        "
      />
    </div>

    <!-- Category Filter -->
    <div>
      <label
        style="
          display: block;
          margin-bottom: 0.5rem;
          font-weight: 600;
          color: var(--medium-brown);
        "
        >Category</label
      >
      <select
        id="category-filter"
        style="
          width: 100%;
          padding: 0.8rem;
          border: 1px solid var(--creme-dark);
          border-radius: 4px;
        "
      >
        <option value="">All Categories</option>
      </select>
    </div>

    <!-- Add Product Button -->
    <button
      id="add-product-btn"
      style="
        background-color: #28a745;
        color: white;
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 4px;
        cursor: pointer;
        align-self: flex-end;
        font-weight: 600;
      "
    >
      <i class="fas fa-plus"></i> Add Product
    </button>
  </div>

  <!-- Results Info -->
  <div style="margin-bottom: 1rem; color: var(--medium-brown)">
    <p>Showing <strong id="product-count">0</strong> products</p>
  </div>

  <!-- Products Grid -->
  <div class="row" id="products-grid"></div>

  <!-- Empty State -->
  <div
    id="products-empty"
    style="text-align: center; padding: 3rem; display: none"
  >
    <i
      class="fas fa-inbox"
      style="font-size: 3rem; color: var(--creme-dark); margin-bottom: 1rem"
    ></i>
    <p style="color: var(--medium-brown); font-size: 1.1rem">
      No products found
    </p>
  </div>

  <!-- Loading State -->
  <div id="products-loading" style="text-align: center; padding: 3rem">
    <div class="spinner" style="margin: 0 auto"></div>
    <p style="color: var(--medium-brown); margin-top: 1rem">
      Loading products...
    </p>
  </div>
</main>

<!-- Add Product Modal -->
<div class="admin-modal-overlay" id="addProductModal">
  <div
    class="admin-modal"
    style="max-width: 600px; max-height: 90vh; overflow-y: auto"
  >
    <div class="modal-header">
      <h3>Add New Product</h3>
      <button class="modal-close" onclick="closeModal('addProductModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="add-product-form">
        <div class="form-group">
          <label for="add_product_name">Product Name *</label>
          <input
            type="text"
            class="form-input"
            id="add_product_name"
            required
          />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="add_product_category">Category *</label>
            <select class="form-input" id="add_product_category" required>
              <option value="">Select Category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="add_product_price">Price ($) *</label>
            <input
              type="number"
              class="form-input"
              id="add_product_price"
              step="0.01"
              min="0"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="add_product_description">Description</label>
          <textarea
            class="form-input"
            id="add_product_description"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="add_product_dimensions"
            >Dimensions (W x H x D in cm)</label
          >
          <input
            type="text"
            class="form-input"
            id="add_product_dimensions"
            placeholder="e.g., 100 x 200 x 50"
          />
        </div>

        <div class="form-group">
          <label for="add_product_weight">Weight (kg)</label>
          <input
            type="number"
            class="form-input"
            id="add_product_weight"
            step="0.1"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_delivery_fee">Delivery Fee</label>
          <input
            type="number"
            class="form-input"
            id="add_product_delivery_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_assembly_fee">Assembly Fee</label>
          <input
            type="number"
            class="form-input"
            id="add_product_assembly_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="add_product_image">Product Images *</label>
          <div
            id="add_product_images_preview"
            style="
              margin-bottom: 1rem;
              display: grid;
              grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
              gap: 0.5rem;
            "
          >
            <!-- Image previews will be shown here -->
          </div>
          <input
            type="file"
            class="form-input"
            id="add_product_image"
            accept="image/*"
            multiple
            required
          />
          <small style="color: var(--medium-brown)"
            >JPG, PNG, GIF, WebP up to 5MB each. Select multiple images.</small
          >
        </div>

        <button
          type="submit"
          class="table-action-btn"
          style="
            width: 100%;
            margin-top: 1rem;
            background-color: #28a745;
            color: white;
          "
        >
          <i class="fas fa-plus"></i> Add Product
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div class="admin-modal-overlay" id="editProductModal">
  <div
    class="admin-modal"
    style="max-width: 600px; max-height: 90vh; overflow-y: auto"
  >
    <div class="modal-header">
      <h3>Edit Product</h3>
      <button class="modal-close" onclick="closeModal('editProductModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="edit-product-form">
        <input type="hidden" id="edit_product_id" />

        <div class="form-group">
          <label for="edit_product_name">Product Name *</label>
          <input
            type="text"
            class="form-input"
            id="edit_product_name"
            required
          />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="edit_product_category">Category *</label>
            <select class="form-input" id="edit_product_category" required>
              <option value="">Select Category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="edit_product_price">Price ($) *</label>
            <input
              type="number"
              class="form-input"
              id="edit_product_price"
              step="0.01"
              min="0"
              required
            />
          </div>
        </div>

        <div class="form-group">
          <label for="edit_product_description">Description</label>
          <textarea
            class="form-input"
            id="edit_product_description"
            rows="3"
          ></textarea>
        </div>

        <div class="form-group">
          <label for="edit_product_dimensions"
            >Dimensions (W x H x D in cm)</label
          >
          <input
            type="text"
            class="form-input"
            id="edit_product_dimensions"
            placeholder="e.g., 100 x 200 x 50"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_weight">Weight (kg)</label>
          <input
            type="number"
            class="form-input"
            id="edit_product_weight"
            step="0.1"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_delivery_fee"
            >Delivery Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="edit_product_delivery_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_assembly_fee"
            >Assembly Fee Override ($)</label
          >
          <input
            type="number"
            class="form-input"
            id="edit_product_assembly_fee"
            step="0.01"
            min="0"
          />
        </div>

        <div class="form-group">
          <label for="edit_product_image">Product Image</label>
          <div style="margin-bottom: 1rem">
            <img
              id="edit_product_image_preview"
              src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E"
              alt="Product preview"
              style="max-width: 200px; max-height: 200px; border-radius: 4px"
            />
          </div>
          <input
            type="file"
            class="form-input"
            id="edit_product_image"
            accept="image/*"
          />
          <small style="color: var(--medium-brown)"
            >JPG, PNG, GIF, WebP up to 5MB</small
          >
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
          <button type="submit" class="table-action-btn" style="flex: 1">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button
            type="button"
            class="table-action-btn secondary"
            onclick="openProductImageGallery()"
            style="flex: 1"
          >
            <i class="fas fa-images"></i> Manage Images
          </button>
          <button
            type="button"
            class="table-action-btn secondary"
            onclick="deleteProductConfirm()"
            style="flex: 1"
          >
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Image Gallery Modal -->
<div class="admin-modal-overlay" id="imageGalleryModal">
  <div
    class="admin-modal"
    style="max-width: 700px; max-height: 90vh; overflow-y: auto"
  >
    <div class="modal-header">
      <h3>Product Images</h3>
      <button class="modal-close" onclick="closeModal('imageGalleryModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="gallery_product_id" />

      <div style="margin-bottom: 2rem">
        <label
          style="
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--medium-brown);
          "
        >
          Add New Image
        </label>
        <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem">
          <input
            type="file"
            id="gallery_new_image"
            accept="image/*"
            class="form-input"
            style="flex: 1"
          />
          <button
            class="table-action-btn"
            onclick="uploadGalleryImage()"
            style="white-space: nowrap"
          >
            <i class="fas fa-upload"></i> Upload
          </button>
        </div>
        <small style="color: var(--medium-brown)"
          >JPG, PNG, GIF, WebP up to 5MB</small
        >
      </div>

      <div
        style="
          border-top: 2px solid var(--creme-dark);
          padding-top: 1.5rem;
          margin-top: 1rem;
        "
      >
        <h4 style="color: var(--medium-brown); margin-bottom: 1rem">
          Current Images
        </h4>
        <div
          id="images-gallery-container"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
          "
        >
          <!-- Images will be populated here -->
        </div>
      </div>

      <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
        <button
          type="button"
          class="table-action-btn"
          onclick="closeModal('imageGalleryModal')"
          style="flex: 1"
        >
          <i class="fas fa-check"></i> Done
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  // Use window object to avoid redeclaration errors when page loads multiple times
  if (!window.adminProductsState) {
    window.adminProductsState = {
      allProducts: [],
      allCategories: [],
      filteredProducts: [],
      isLoadingProducts: false,
    };
  }

  // Initialize if DOM is already loaded (happens when injected into existing page)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", function () {
      initAdminProducts_Page();
    });
  } else {
    // DOM already loaded - page was dynamically injected
    // Initialize after a small delay to ensure elements are in DOM
    setTimeout(() => {
      initAdminProducts_Page();
    }, 100);
  }

  // This function is called both by DOMContentLoaded and by router
  function initAdminProducts_Page() {
    // Check if required elements exist
    const requiredElements = [
      "products-loading",
      "products-grid",
      "product-search",
      "category-filter",
      "add-product-btn",
    ];

    const missingElements = requiredElements.filter(
      (id) => !document.getElementById(id)
    );
    if (missingElements.length > 0) {
      console.error("[AdminProducts] Missing elements:", missingElements);
      return;
    }

    // Load categories FIRST, then products, then setup listeners
    loadCategoriesAndThenProducts();
    setupEventListeners();
  }

  // Load categories first, then load products after categories are ready
  function loadCategoriesAndThenProducts() {
    const token = localStorage.getItem("user_token");

    if (!token) {
      console.error("[AdminProducts] No token");
      return;
    }

    // Load categories
    fetch(Constants.get_api_base_url() + "categories", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => response.json())
      .then((data) => {
        window.adminProductsState.allCategories = Array.isArray(data)
          ? data
          : data.data || [];

        // Populate category selects
        const categorySelects = [
          "add_product_category",
          "edit_product_category",
        ];
        categorySelects.forEach((selectId) => {
          const select = document.getElementById(selectId);
          if (!select) return;
          // Clear existing options except the first one
          while (select.options.length > 1) {
            select.remove(1);
          }
          window.adminProductsState.allCategories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.category_id || cat.id;
            option.textContent = cat.name;
            select.appendChild(option);
          });
        });

        // Populate filter
        const filterSelect = document.getElementById("category-filter");
        if (filterSelect) {
          // Clear existing options except the first one
          while (filterSelect.options.length > 1) {
            filterSelect.remove(1);
          }
          window.adminProductsState.allCategories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.category_id || cat.id;
            option.textContent = cat.name;
            filterSelect.appendChild(option);
          });
        }

        // NOW load products after categories are ready
        loadProducts();
      })
      .catch((error) => {
        console.error("[AdminProducts] Error loading categories:", error);
        loadProducts(); // Still load products even if categories fail
      });
  }

  // Make it global so router can call it
  window.initAdminProducts_Page = initAdminProducts_Page;

  function setupEventListeners() {
    // Remove old listeners by cloning and replacing elements to avoid duplicates
    let addBtn = document.getElementById("add-product-btn");
    if (addBtn && addBtn.parentNode) {
      const addBtnClone = addBtn.cloneNode(true);
      addBtn.parentNode.replaceChild(addBtnClone, addBtn);
      addBtn = addBtnClone;
    }

    let addForm = document.getElementById("add-product-form");
    if (addForm && addForm.parentNode) {
      const addFormClone = addForm.cloneNode(true);
      addForm.parentNode.replaceChild(addFormClone, addForm);
      addForm = addFormClone;
    }

    let editForm = document.getElementById("edit-product-form");
    if (editForm && editForm.parentNode) {
      const editFormClone = editForm.cloneNode(true);
      editForm.parentNode.replaceChild(editFormClone, editForm);
      editForm = editFormClone;
    }

    let addImageInput = document.getElementById("add_product_image");
    if (addImageInput && addImageInput.parentNode) {
      const addImageInputClone = addImageInput.cloneNode(true);
      addImageInput.parentNode.replaceChild(addImageInputClone, addImageInput);
      addImageInput = addImageInputClone;
    }

    let editImageInput = document.getElementById("edit_product_image");
    if (editImageInput && editImageInput.parentNode) {
      const editImageInputClone = editImageInput.cloneNode(true);
      editImageInput.parentNode.replaceChild(
        editImageInputClone,
        editImageInput
      );
      editImageInput = editImageInputClone;
    }

    let searchInput = document.getElementById("product-search");
    if (searchInput && searchInput.parentNode) {
      const searchInputClone = searchInput.cloneNode(true);
      searchInput.parentNode.replaceChild(searchInputClone, searchInput);
      searchInput = searchInputClone;
    }

    let categoryFilter = document.getElementById("category-filter");
    if (categoryFilter && categoryFilter.parentNode) {
      const categoryFilterClone = categoryFilter.cloneNode(true);
      categoryFilter.parentNode.replaceChild(
        categoryFilterClone,
        categoryFilter
      );
      categoryFilter = categoryFilterClone;
    }

    // Add event listeners
    if (addBtn) {
      addBtn.addEventListener("click", function () {
        if (addForm) {
          addForm.reset();
        }
        const previewDiv = document.getElementById(
          "add_product_images_preview"
        );
        if (previewDiv) {
          previewDiv.innerHTML = "";
        }
        openModal("addProductModal");
      });
    }

    const addProductForm = document.getElementById("add-product-form");
    if (addProductForm) {
      addProductForm.addEventListener("submit", function (e) {
        e.preventDefault();
        addProduct();
      });
    }

    const editProductForm = document.getElementById("edit-product-form");
    if (editProductForm) {
      editProductForm.addEventListener("submit", function (e) {
        e.preventDefault();
        saveProduct();
      });
    }

    const addProductImage = document.getElementById("add_product_image");
    if (addProductImage) {
      addProductImage.addEventListener("change", function (e) {
        const files = e.target.files;
        const preview = document.getElementById("add_product_images_preview");
        preview.innerHTML = "";

        if (files.length > 0) {
          for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = document.createElement("img");
              img.src = event.target.result;
              img.style.width = "100%";
              img.style.height = "100px";
              img.style.objectFit = "cover";
              img.style.borderRadius = "4px";
              img.style.border = "2px solid var(--burgundy-light)";
              preview.appendChild(img);
            };
            reader.readAsDataURL(file);
          }
        }
      });
    }

    // Add event listeners for search and filter
    const searchInputElement = document.getElementById("product-search");
    if (searchInputElement) {
      searchInputElement.addEventListener("input", applyFilters);
    }

    const categoryFilterElement = document.getElementById("category-filter");
    if (categoryFilterElement) {
      categoryFilterElement.addEventListener("change", applyFilters);
    }

    // Add image preview for edit form
    const editProductImage = document.getElementById("edit_product_image");
    if (editProductImage) {
      editProductImage.addEventListener("change", function (e) {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (event) {
            document.getElementById("edit_product_image_preview").src =
              event.target.result;
          };
          reader.readAsDataURL(file);
        }
      });
    }
  }

  function loadProducts() {
    if (window.adminProductsState.isLoadingProducts) {
      return;
    }

    window.adminProductsState.isLoadingProducts = true;
    const token = localStorage.getItem("user_token");
    const loadingDiv = document.getElementById("products-loading");
    const emptyDiv = document.getElementById("products-empty");
    const grid = document.getElementById("products-grid");

    if (!loadingDiv) {
      console.error("[AdminProducts] loadingDiv not found!");
      window.adminProductsState.isLoadingProducts = false;
      return;
    }

    if (!token) {
      console.error("[AdminProducts] No token found in localStorage");
      loadingDiv.style.display = "none";
      showToast("Session expired. Please login again.", "error");
      window.location.hash = "#login";
      window.adminProductsState.isLoadingProducts = false;
      return;
    }

    loadingDiv.style.display = "block";
    if (emptyDiv) emptyDiv.style.display = "none";
    if (grid) grid.innerHTML = "";

    const apiUrl = Constants.get_api_base_url() + "products?limit=100";

    fetch(apiUrl, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          console.error(
            "[AdminProducts] 401 Unauthorized - token may be invalid"
          );
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }

        if (!response.ok) {
          console.error(
            "[AdminProducts] Non-OK status:",
            response.status,
            response.statusText
          );
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        return response.json();
      })
      .then((data) => {
        if (!data) {
          loadingDiv.style.display = "none";
          window.adminProductsState.isLoadingProducts = false;
          return;
        }

        // Handle both array response and {data: [...]} response format
        if (Array.isArray(data)) {
          window.adminProductsState.allProducts = data;
        } else if (data.data && Array.isArray(data.data)) {
          window.adminProductsState.allProducts = data.data;
        } else {
          window.adminProductsState.allProducts = [];
        }

        // Remove duplicates by product_id
        const uniqueProducts = [];
        const seenIds = new Set();
        for (const product of window.adminProductsState.allProducts) {
          const id = product.product_id || product.id;
          if (!seenIds.has(id)) {
            seenIds.add(id);
            uniqueProducts.push(product);
          }
        }

        if (
          uniqueProducts.length !== window.adminProductsState.allProducts.length
        ) {
          window.adminProductsState.allProducts = uniqueProducts;
        }

        window.adminProductsState.filteredProducts = [
          ...window.adminProductsState.allProducts,
        ];

        loadingDiv.style.display = "none";
        window.adminProductsState.isLoadingProducts = false;
        renderProducts();
      })
      .catch((error) => {
        console.error("[AdminProducts] Error loading products:", error);
        console.error("[AdminProducts] Error stack:", error.stack);
        loadingDiv.style.display = "none";
        window.adminProductsState.isLoadingProducts = false;
        if (emptyDiv) {
          emptyDiv.style.display = "block";
          emptyDiv.innerHTML = `<p>Error loading products: ${error.message}</p>`;
        }
        showToast("Error loading products: " + error.message, "error");
      });
  }

  function applyFilters() {
    const searchTerm = document
      .getElementById("product-search")
      .value.toLowerCase();
    const categoryId = document.getElementById("category-filter").value;

    window.adminProductsState.filteredProducts =
      window.adminProductsState.allProducts.filter((product) => {
        if (searchTerm && !product.name.toLowerCase().includes(searchTerm)) {
          return false;
        }

        if (categoryId && product.category_id != categoryId) {
          return false;
        }

        return true;
      });

    renderProducts();
  }

  function renderProducts() {
    const grid = document.getElementById("products-grid");
    const emptyDiv = document.getElementById("products-empty");
    const countDiv = document.getElementById("product-count");

    if (!grid) {
      console.error("[AdminProducts] products-grid element not found!");
      return;
    }

    grid.innerHTML = "";
    if (countDiv)
      countDiv.textContent = window.adminProductsState.filteredProducts.length;

    if (window.adminProductsState.filteredProducts.length === 0) {
      if (emptyDiv) emptyDiv.style.display = "block";
      grid.style.display = "none";
      return;
    }

    if (emptyDiv) emptyDiv.style.display = "none";
    grid.style.display = "grid";
    window.adminProductsState.filteredProducts.forEach((product, index) => {
      try {
        const col = document.createElement("div");
        col.className = "col-lg-4 col-md-6 mb-4";
        col.innerHTML = `
          <div class="product-card-admin">
            <img src="${
              product.image_url ||
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='300'%3E%3Crect fill='%23e0e0e0' width='300' height='300'/%3E%3Ctext x='50%25' y='50%25' font-size='16' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E"
            }" alt="${product.name}" class="product-image-admin" />
            <div class="product-content-admin">
              <h3 class="product-title-admin">${product.name}</h3>
              <p class="product-category-admin">${getCategoryName(
                product.category_id
              )}</p>
              <div class="product-price-admin">$${parseFloat(
                product.price
              ).toFixed(2)}</div>
              <div class="product-actions-admin">
                <button class="table-action-btn" onclick="editProduct(${
                  product.product_id
                })" style="flex: 1">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="table-action-btn secondary" onclick="deleteProductConfirm(${
                  product.product_id
                })" style="flex: 1">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </div>
          </div>
        `;
        grid.appendChild(col);
      } catch (error) {
        console.error(
          "[AdminProducts] Error rendering product at index",
          index,
          ":",
          error,
          "Product:",
          product
        );
      }
    });
  }

  function getCategoryName(categoryId) {
    if (!categoryId) return "Uncategorized";

    const category = window.adminProductsState.allCategories.find((c) => {
      // Check both category_id and id fields
      return c.category_id == categoryId || c.id == categoryId;
    });

    return category ? category.name : "Uncategorized";
  }

  function editProduct(productId) {
    const product = window.adminProductsState.allProducts.find(
      (p) => p.product_id == productId
    );
    if (!product) {
      showToast("Product not found", "error");
      return;
    }

    document.getElementById("edit_product_id").value = productId;
    document.getElementById("edit_product_name").value = product.name || "";
    document.getElementById("edit_product_category").value =
      product.category_id || "";
    document.getElementById("edit_product_price").value = product.price || "";
    document.getElementById("edit_product_description").value =
      product.description || "";
    document.getElementById("edit_product_dimensions").value =
      product.width_cm && product.height_cm && product.depth_cm
        ? `${product.width_cm} x ${product.height_cm} x ${product.depth_cm}`
        : "";
    document.getElementById("edit_product_weight").value =
      product.weight_kg || "";
    document.getElementById("edit_product_delivery_fee").value =
      product.delivery_fee_override || "";
    document.getElementById("edit_product_assembly_fee").value =
      product.assembly_fee_override || "";

    // Set image preview
    const imagePreview = document.getElementById("edit_product_image_preview");
    if (product.image_url) {
      imagePreview.src = product.image_url;
    } else {
      imagePreview.src =
        "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Crect fill='%23e0e0e0' width='200' height='200'/%3E%3Ctext x='50%25' y='50%25' font-size='14' fill='%23999' text-anchor='middle' dy='.3em'%3ENo Image%3C/text%3E%3C/svg%3E";
    }

    // Clear the file input
    document.getElementById("edit_product_image").value = "";

    openModal("editProductModal");
  }

  function addProduct() {
    const name = document.getElementById("add_product_name").value.trim();
    const categoryId = document.getElementById("add_product_category").value;
    const price = document.getElementById("add_product_price").value;
    const description = document
      .getElementById("add_product_description")
      .value.trim();
    const dimensions = document
      .getElementById("add_product_dimensions")
      .value.trim();
    const weight = document.getElementById("add_product_weight").value || null;
    const deliveryFee =
      document.getElementById("add_product_delivery_fee").value || null;
    const assemblyFee =
      document.getElementById("add_product_assembly_fee").value || null;
    const imageFiles = document.getElementById("add_product_image").files;

    if (!name || !categoryId || !price) {
      showToast("Please fill in all required fields", "error");
      return;
    }

    if (imageFiles.length === 0) {
      showToast("Please select at least one product image", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    // Upload all images first
    uploadMultipleImages(
      Array.from(imageFiles),
      token,
      0,
      [],
      function (imageUrls) {
        // After all images are uploaded, create the product with the first image URL
        createProductData(
          name,
          categoryId,
          price,
          description,
          dimensions,
          weight,
          deliveryFee,
          assemblyFee,
          imageUrls,
          token
        );
      }
    );
  }

  function createProductData(
    name,
    categoryId,
    price,
    description,
    dimensions,
    weight,
    deliveryFee,
    assemblyFee,
    imageUrls,
    token
  ) {
    // Parse dimensions
    let width, height, depth;
    if (dimensions) {
      const parts = dimensions.split("x").map((p) => parseFloat(p.trim()));
      width = parts[0] || null;
      height = parts[1] || null;
      depth = parts[2] || null;
    }

    // Use first image as the primary image_url
    const primaryImageUrl = Array.isArray(imageUrls) ? imageUrls[0] : imageUrls;

    const productData = {
      name: name,
      category_id: categoryId,
      price: price,
      description: description,
      width_cm: width,
      height_cm: height,
      depth_cm: depth,
      weight_kg: weight,
      delivery_fee_override: deliveryFee,
      assembly_fee_override: assemblyFee,
      image_url: primaryImageUrl,
    };

    showToast("Adding product...", "info");

    fetch(Constants.get_api_base_url() + "products", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(productData),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error adding product");
          });
        }
        return response.json();
      })
      .then((data) => {
        // Get the product ID from the response
        const productId = data.product_id || data.id;

        if (!productId) {
          throw new Error("Product created but no ID returned");
        }

        // After product is created, add remaining images if there are more than one
        if (Array.isArray(imageUrls) && imageUrls.length > 1) {
          addRemainingImages(
            productId,
            imageUrls.slice(1),
            token,
            0,
            function () {
              // Only after all images are added, show success and reload
              showToast("Product added successfully!", "success");
              closeModal("addProductModal");
              document.getElementById("add-product-form").reset();
              document.getElementById("add_product_images_preview").innerHTML =
                "";
              loadProducts();
            }
          );
        } else {
          // No additional images, show success immediately
          showToast("Product added successfully!", "success");
          closeModal("addProductModal");
          document.getElementById("add-product-form").reset();
          document.getElementById("add_product_images_preview").innerHTML = "";
          loadProducts();
        }
      })
      .catch((error) => {
        console.error("Error adding product:", error);
        showToast(error.message || "Error adding product.", "error");
      });
  }

  function addRemainingImages(productId, imageUrls, token, index, callback) {
    if (!imageUrls || imageUrls.length === 0) {
      if (callback) callback();
      return;
    }

    if (index >= imageUrls.length) {
      if (callback) callback();
      return;
    }

    const imageUrl = imageUrls[index];

    fetch(`http://localhost/diplomski/backend/products/${productId}/images`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify({ image_url: imageUrl }),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error("Failed to add image");
        }
        return response.json();
      })
      .then((data) => {
        // Add next image
        addRemainingImages(productId, imageUrls, token, index + 1, callback);
      })
      .catch((error) => {
        console.error("Error adding image at index " + index + ":", error);
        // Continue with next image even if one fails
        addRemainingImages(productId, imageUrls, token, index + 1, callback);
      });
  }

  function saveProduct() {
    const productId = document.getElementById("edit_product_id").value;
    const name = document.getElementById("edit_product_name").value.trim();
    const categoryId = document.getElementById("edit_product_category").value;
    const price = document.getElementById("edit_product_price").value;
    const description = document
      .getElementById("edit_product_description")
      .value.trim();
    const dimensions = document
      .getElementById("edit_product_dimensions")
      .value.trim();
    const weight = document.getElementById("edit_product_weight").value || null;
    const deliveryFee =
      document.getElementById("edit_product_delivery_fee").value || null;
    const assemblyFee =
      document.getElementById("edit_product_assembly_fee").value || null;
    const imageFile = document.getElementById("edit_product_image").files[0];

    if (!name || !categoryId || !price) {
      showToast("Please fill in all required fields", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    // If there's an image file to upload, upload it first
    if (imageFile) {
      uploadProductImage(imageFile, token, function (imageUrl) {
        // After image upload, update the product with the image URL
        updateProductData(
          productId,
          name,
          categoryId,
          price,
          description,
          dimensions,
          weight,
          deliveryFee,
          assemblyFee,
          imageUrl,
          token
        );
      });
    } else {
      // No image to upload, just update the product
      updateProductData(
        productId,
        name,
        categoryId,
        price,
        description,
        dimensions,
        weight,
        deliveryFee,
        assemblyFee,
        null,
        token
      );
    }
  }

  function uploadMultipleImages(files, token, index, uploadedUrls, callback) {
    if (index >= files.length) {
      // All images uploaded
      callback(uploadedUrls);
      return;
    }

    uploadProductImage(files[index], token, function (imageUrl) {
      uploadedUrls.push(imageUrl);
      // Upload next image
      uploadMultipleImages(files, token, index + 1, uploadedUrls, callback);
    });
  }

  function uploadProductImage(file, token, callback) {
    const formData = new FormData();
    formData.append("itemImage", file);

    fetch(Constants.get_api_base_url() + "api/upload/item-image/", {
      method: "POST",
      headers: {
        Authentication: token,
      },
      body: formData,
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          callback("assets/img/products/" + data.filename);
        } else {
          throw new Error(data.message || "Image upload failed");
        }
      })
      .catch((error) => {
        console.error("Error uploading image:", error);
        showToast("Error uploading image: " + error.message, "error");
      });
  }

  function updateProductData(
    productId,
    name,
    categoryId,
    price,
    description,
    dimensions,
    weight,
    deliveryFee,
    assemblyFee,
    imageUrl,
    token
  ) {
    // Parse dimensions
    let width, height, depth;
    if (dimensions) {
      const parts = dimensions.split("x").map((p) => parseFloat(p.trim()));
      width = parts[0] || null;
      height = parts[1] || null;
      depth = parts[2] || null;
    }

    const productData = {
      name: name,
      category_id: categoryId,
      price: price,
      description: description,
      width_cm: width,
      height_cm: height,
      depth_cm: depth,
      weight_kg: weight,
      delivery_fee_override: deliveryFee,
      assembly_fee_override: assemblyFee,
    };

    // Add image URL only if it was provided
    if (imageUrl) {
      productData.image_url = imageUrl;
    }

    showToast("Updating product...", "info");

    fetch(Constants.get_api_base_url() + `products/${productId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(productData),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error updating product");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Product updated successfully!", "success");
        closeModal("editProductModal");
        loadProducts();
      })
      .catch((error) => {
        console.error("Error updating product:", error);
        showToast(error.message || "Error updating product.", "error");
      });
  }

  function deleteProductConfirm(productId = null) {
    const id = productId || document.getElementById("edit_product_id").value;
    const product = window.adminProductsState.allProducts.find(
      (p) => p.product_id == id || p.id == id
    );

    if (!product) {
      showToast("Product not found", "error");
      return;
    }

    if (
      confirm(
        `Are you sure you want to delete "${product.name}"? This action cannot be undone.`
      )
    ) {
      deleteProduct(id);
    }
  }

  function deleteProduct(productId) {
    const token = localStorage.getItem("user_token");

    showToast("Deleting product...", "info");

    fetch(Constants.get_api_base_url() + `products/${productId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error deleting product");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Product deleted successfully!", "success");
        closeModal("editProductModal");
        loadProducts();
      })
      .catch((error) => {
        console.error("Error deleting product:", error);
        showToast(error.message || "Error deleting product.", "error");
      });
  }

  // Image Gallery Functions
  function openProductImageGallery() {
    const productId = document.getElementById("edit_product_id").value;
    if (!productId) {
      showToast("Please save the product first", "error");
      return;
    }

    document.getElementById("gallery_product_id").value = productId;
    document.getElementById("gallery_new_image").value = "";

    loadProductImages(productId);
    openModal("imageGalleryModal");
  }

  function loadProductImages(productId) {
    const token = localStorage.getItem("user_token");
    const container = document.getElementById("images-gallery-container");
    container.innerHTML = "<p>Loading images...</p>";

    fetch(Constants.get_api_base_url() + `products/${productId}`, {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (!response.ok) throw new Error("Failed to load product");
        return response.json();
      })
      .then((product) => {
        const images = product.images || [];
        container.innerHTML = "";

        if (images.length === 0) {
          container.innerHTML =
            "<p style='grid-column: 1/-1; text-align: center; color: var(--medium-brown)'>No images yet. Add one above.</p>";
          return;
        }

        images.forEach((image) => {
          const imageCard = document.createElement("div");
          imageCard.style.position = "relative";
          imageCard.innerHTML = `
            <div style="position: relative; overflow: hidden; border-radius: 8px; aspect-ratio: 1; background: var(--creme-dark)">
              <img src="${
                image.image_url
              }" alt="Product image" style="width: 100%; height: 100%; object-fit: cover;" />
              ${
                image.is_primary
                  ? '<div style="position: absolute; top: 0.5rem; right: 0.5rem; background: var(--burgundy-primary); color: white; padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: bold">PRIMARY</div>'
                  : ""
              }
              <button type="button" class="table-action-btn secondary" style="position: absolute; bottom: 0.5rem; left: 0.5rem; right: 0.5rem; width: auto" onclick="deleteProductImageConfirm(${
                image.image_id
              }, ${productId})">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          `;
          container.appendChild(imageCard);
        });
      })
      .catch((error) => {
        console.error("Error loading images:", error);
        container.innerHTML = `<p style='grid-column: 1/-1; color: red'>Error loading images: ${error.message}</p>`;
      });
  }

  function uploadGalleryImage() {
    const productId = document.getElementById("gallery_product_id").value;
    const imageFile = document.getElementById("gallery_new_image").files[0];

    if (!imageFile) {
      showToast("Please select an image", "error");
      return;
    }

    if (!productId) {
      showToast("Product ID not found", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    uploadProductImage(imageFile, token, function (imageUrl) {
      addImageToProduct(productId, imageUrl, token);
    });
  }

  function addImageToProduct(productId, imageUrl, token) {
    showToast("Adding image...", "info");

    fetch(Constants.get_api_base_url() + `products/${productId}/images`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify({ image_url: imageUrl }),
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error adding image");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Image added successfully!", "success");
        document.getElementById("gallery_new_image").value = "";
        loadProductImages(productId);
      })
      .catch((error) => {
        console.error("Error adding image:", error);
        showToast(error.message || "Error adding image.", "error");
      });
  }

  function deleteProductImageConfirm(imageId, productId) {
    if (confirm("Are you sure you want to delete this image?")) {
      deleteProductImageAPI(imageId, productId);
    }
  }

  function deleteProductImageAPI(imageId, productId) {
    const token = localStorage.getItem("user_token");

    showToast("Deleting image...", "info");

    fetch(
      Constants.get_api_base_url() + `products/${productId}/images/${imageId}`,
      {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json",
          Authentication: token,
        },
      }
    )
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error deleting image");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Image deleted successfully!", "success");
        loadProductImages(productId);
      })
      .catch((error) => {
        console.error("Error deleting image:", error);
        showToast(error.message || "Error deleting image.", "error");
      });
  }

  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add("active");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
    }
  }
</script>

<style>
  .product-card-admin {
    position: relative;
    overflow: hidden;
    margin-bottom: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(62, 39, 35, 0.1);
    transition: all 0.3s ease;
    border: 1px solid var(--creme-dark);
  }

  .product-card-admin:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(62, 39, 35, 0.15);
  }

  .product-image-admin {
    width: 100%;
    height: 200px;
    object-fit: cover;
  }

  .product-content-admin {
    padding: 1.5rem;
  }

  .product-title-admin {
    color: var(--burgundy-primary);
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 1.1rem;
  }

  .product-category-admin {
    color: var(--medium-brown);
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
  }

  .product-price-admin {
    color: var(--burgundy-dark);
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }

  .product-meta-admin {
    display: flex;
    justify-content: space-between;
    color: var(--medium-brown);
    font-size: 0.85rem;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid var(--creme-dark);
  }

  .product-meta-admin span {
    display: flex;
    align-items: center;
    gap: 0.3rem;
  }

  .product-actions-admin {
    display: flex;
    gap: 0.5rem;
  }

  .product-actions-admin .table-action-btn {
    flex: 1;
    text-align: center;
    padding: 0.5rem;
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
    font-family: inherit;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }

  .form-row-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  @media (max-width: 768px) {
    .row {
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }

    .form-row-2 {
      grid-template-columns: 1fr;
    }
  }
</style>
