<!-- ================= ADMIN CATEGORIES MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header with Back Button -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>Categories</h1>
        <p>Manage Product Categories</p>
      </div>
      <button
        class="table-action-btn secondary"
        onclick="window.location.hash='admin-dashboard'"
      >
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>
  </div>

  <!-- Add Category Button -->
  <div class="mb-4 text-start">
    <button class="table-action-btn" id="add-category-btn">
      <i class="fas fa-plus"></i> Add Category
    </button>
  </div>

  <!-- Loading State -->
  <div id="categories-loading" style="text-align: center; padding: 3rem">
    <div class="spinner" style="margin: 0 auto"></div>
    <p style="color: var(--medium-brown); margin-top: 1rem">
      Loading categories...
    </p>
  </div>

  <!-- Empty State -->
  <div
    id="categories-empty"
    style="text-align: center; padding: 3rem; display: none"
  >
    <i
      class="fas fa-inbox"
      style="font-size: 3rem; color: var(--creme-dark); margin-bottom: 1rem"
    ></i>
    <p style="color: var(--medium-brown); font-size: 1.1rem">
      No categories found
    </p>
  </div>

  <!-- Categories Grid -->
  <div class="row" id="categories-on-admin-dashboard"></div>
</main>

<!-- Add/Edit Category Modal -->
<div class="admin-modal-overlay" id="categoryModal">
  <div class="admin-modal" style="max-width: 500px">
    <div class="modal-header">
      <h3 id="modalTitle">Add Category</h3>
      <button class="modal-close" onclick="closeModal('categoryModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="category-form">
        <input type="hidden" id="category_id" />

        <div class="form-group">
          <label for="category_name">Category Name *</label>
          <input type="text" class="form-input" id="category_name" required />
        </div>

        <div class="form-group">
          <label for="category_description">Description</label>
          <textarea
            class="form-input"
            id="category_description"
            rows="2"
          ></textarea>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1rem">
          <button type="submit" class="table-action-btn" style="flex: 1">
            <i class="fas fa-save"></i> Save Category
          </button>
          <button
            type="button"
            class="table-action-btn secondary"
            id="delete-category-btn"
            style="flex: 1; display: none"
            onclick="deleteCategoryConfirm()"
          >
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Use window object to avoid redeclaration errors
  if (!window.adminCategoriesState) {
    window.adminCategoriesState = {
      allCategories: [],
      isEditing: false,
      currentEditingCategoryId: null,
    };
  }

  // Initialize
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initCategories);
  } else {
    setTimeout(() => {
      initCategories();
    }, 100);
  }

  window.initAdminCategories = initCategories;

  function initCategories() {
    loadCategories();
    setupEventListeners();
  }

  function setupEventListeners() {
    // Remove old listeners by cloning elements
    const addBtn = document.getElementById("add-category-btn");
    const addBtnClone = addBtn.cloneNode(true);
    addBtn.parentNode.replaceChild(addBtnClone, addBtn);

    const form = document.getElementById("category-form");
    const formClone = form.cloneNode(true);
    form.parentNode.replaceChild(formClone, form);

    // Add new listeners
    document
      .getElementById("add-category-btn")
      .addEventListener("click", openAddCategoryModal);
    document
      .getElementById("category-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        saveCategory();
      });
  }

  function loadCategories() {
    const token = localStorage.getItem("user_token");
    const loadingDiv = document.getElementById("categories-loading");
    const emptyDiv = document.getElementById("categories-empty");
    const grid = document.getElementById("categories-on-admin-dashboard");

    if (!token) {
      showToast("Session expired. Please login again.", "error");
      window.location.hash = "#login";
      return;
    }

    loadingDiv.style.display = "block";
    if (emptyDiv) emptyDiv.style.display = "none";
    if (grid) grid.innerHTML = "";

    fetch("http://localhost/diplomski/backend/categories", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }
        if (!response.ok) throw new Error("Failed to load categories");
        return response.json();
      })
      .then((data) => {
        if (!data) {
          loadingDiv.style.display = "none";
          return;
        }

        window.adminCategoriesState.allCategories = Array.isArray(data)
          ? data
          : data.data || [];
        loadingDiv.style.display = "none";

        if (window.adminCategoriesState.allCategories.length === 0) {
          if (emptyDiv) emptyDiv.style.display = "block";
          if (grid) grid.style.display = "none";
        } else {
          if (emptyDiv) emptyDiv.style.display = "none";
          if (grid) grid.style.display = "grid";
          renderCategories();
        }
      })
      .catch((error) => {
        console.error("Error loading categories:", error);
        loadingDiv.style.display = "none";
        if (emptyDiv) {
          emptyDiv.style.display = "block";
          emptyDiv.innerHTML = `<p>Error loading categories: ${error.message}</p>`;
        }
        showToast("Error loading categories: " + error.message, "error");
      });
  }

  function renderCategories() {
    const grid = document.getElementById("categories-on-admin-dashboard");
    grid.innerHTML = "";

    window.adminCategoriesState.allCategories.forEach((category) => {
      const col = document.createElement("div");
      col.className = "col-lg-4 col-md-6 mb-4";
      col.innerHTML = `
        <div class="speaker">
          <div class="details">
            <h3>${category.name}</h3>
            <p><i class="fas fa-tag"></i> ${
              category.description || "No description"
            }</p>
            <div class="admin-actions">
              <button class="table-action-btn" onclick="editCategory(${
                category.category_id
              })" style="flex: 1">
                <i class="fas fa-edit"></i> Edit
              </button>
              <button class="table-action-btn secondary" onclick="deleteCategoryDirect(${
                category.category_id
              })" style="flex: 1">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `;
      grid.appendChild(col);
    });
  }

  function openAddCategoryModal() {
    window.adminCategoriesState.isEditing = false;
    window.adminCategoriesState.currentEditingCategoryId = null;
    document.getElementById("modalTitle").textContent = "Add Category";
    document.getElementById("category-form").reset();
    document.getElementById("category_id").value = "";
    document.getElementById("delete-category-btn").style.display = "none";
    openModal("categoryModal");
  }

  function editCategory(categoryId) {
    const category = window.adminCategoriesState.allCategories.find(
      (c) => c.category_id == categoryId
    );
    if (!category) {
      showToast("Category not found", "error");
      return;
    }

    window.adminCategoriesState.isEditing = true;
    window.adminCategoriesState.currentEditingCategoryId = categoryId;
    document.getElementById("modalTitle").textContent = "Edit Category";
    document.getElementById("category_id").value = categoryId;
    document.getElementById("category_name").value = category.name;
    document.getElementById("category_description").value =
      category.description || "";
    document.getElementById("delete-category-btn").style.display = "block";

    openModal("categoryModal");
  }

  function saveCategory() {
    const categoryId = document.getElementById("category_id").value;
    const name = document.getElementById("category_name").value.trim();
    const description = document
      .getElementById("category_description")
      .value.trim();

    if (!name) {
      showToast("Please enter category name", "error");
      return;
    }

    const token = localStorage.getItem("user_token");

    const categoryData = {
      name: name,
      description: description,
    };

    if (window.adminCategoriesState.isEditing) {
      // Update existing category
      showToast("Updating category...", "info");

      fetch(
        `http://localhost/diplomski/backend/categories/${window.adminCategoriesState.currentEditingCategoryId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            Authentication: token,
          },
          body: JSON.stringify(categoryData),
        }
      )
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {
              throw new Error(data.error || "Error updating category");
            });
          }
          return response.json();
        })
        .then((data) => {
          showToast("Category updated successfully!", "success");
          closeModal("categoryModal");
          loadCategories();
        })
        .catch((error) => {
          console.error("Error updating category:", error);
          showToast(error.message || "Error updating category.", "error");
        });
    } else {
      // Add new category
      showToast("Adding category...", "info");

      fetch("http://localhost/diplomski/backend/categories", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authentication: token,
        },
        body: JSON.stringify(categoryData),
      })
        .then((response) => {
          if (!response.ok) {
            return response.json().then((data) => {
              throw new Error(data.error || "Error adding category");
            });
          }
          return response.json();
        })
        .then((data) => {
          showToast("Category added successfully!", "success");
          closeModal("categoryModal");
          loadCategories();
        })
        .catch((error) => {
          console.error("Error adding category:", error);
          showToast(error.message || "Error adding category.", "error");
        });
    }
  }

  function deleteCategoryConfirm() {
    const categoryId = document.getElementById("category_id").value;
    const category = window.adminCategoriesState.allCategories.find(
      (c) => c.category_id == categoryId
    );

    if (!category) {
      showToast("Category not found", "error");
      return;
    }

    if (
      confirm(
        `Are you sure you want to delete "${category.name}"? This action cannot be undone.`
      )
    ) {
      deleteCategory(categoryId);
    }
  }

  function deleteCategoryDirect(categoryId) {
    const category = window.adminCategoriesState.allCategories.find(
      (c) => c.category_id == categoryId
    );

    if (!category) {
      showToast("Category not found", "error");
      return;
    }

    if (
      confirm(
        `Are you sure you want to delete "${category.name}"? This action cannot be undone.`
      )
    ) {
      deleteCategory(categoryId);
    }
  }

  function deleteCategory(categoryId) {
    const token = localStorage.getItem("user_token");

    showToast("Deleting category...", "info");

    fetch(`http://localhost/diplomski/backend/categories/${categoryId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (!response.ok) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error deleting category");
          });
        }
        return response.json();
      })
      .then((data) => {
        showToast("Category deleted successfully!", "success");
        closeModal("categoryModal");
        loadCategories();
      })
      .catch((error) => {
        console.error("Error deleting category:", error);
        showToast(error.message || "Error deleting category.", "error");
      });
  }

  function getCategoryIcon(name) {
    const icons = {
      Sofas: "couch",
      Tables: "table",
      Chairs: "chair",
      Beds: "bed",
      Storage: "archive",
      Outdoor: "umbrella-beach",
      Living: "home",
      Dining: "utensils",
      Office: "laptop",
      Bedroom: "bed",
      Garden: "leaf",
    };

    for (const [key, icon] of Object.entries(icons)) {
      if (name.includes(key)) {
        return icon;
      }
    }

    return "tag"; // default icon
  }

  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add("active");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
    }
  }
</script>

<style>
  /* Category Card Styles */
  .speaker {
    position: relative;
    overflow: hidden;
    margin-bottom: 30px;
    background: white;
    border-radius: 5px;
    box-shadow: 0px 2px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
    border: 1px solid var(--creme-dark);
  }

  .speaker:hover {
    transform: translateY(-10px);
    box-shadow: 0px 15px 30px rgba(0, 0, 0, 0.2);
  }

  .speaker .details {
    padding: 20px;
  }

  .speaker .details h3 {
    color: var(--burgundy-primary);
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 18px;
  }

  .speaker .details p {
    color: var(--medium-brown);
    margin-bottom: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .speaker .details p i {
    color: var(--burgundy-light);
    width: 16px;
  }

  .speaker .admin-actions {
    margin-top: 15px;
    display: flex;
    gap: 0.5rem;
  }

  .speaker .admin-actions .table-action-btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 12px;
    text-align: center;
  }

  /* Grid Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }
</style>
