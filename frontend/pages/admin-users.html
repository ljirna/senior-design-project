<!-- ================= ADMIN USERS MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header with Back Button -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>Customers</h1>
        <p>Manage All Customers</p>
      </div>
      <div style="display: flex; gap: 1rem">
        <button
          class="table-action-btn secondary"
          onclick="window.location.hash='admin-dashboard'"
        >
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Users Grid -->
  <div class="row" id="users-on-admin-dashboard">
    <!-- Users will be loaded dynamically from API -->
  </div>

  <!-- Loading indicator -->
  <div id="users-loading" style="text-align: center; padding: 2rem">
    <p>Loading users...</p>
  </div>

  <!-- No users message -->
  <div
    id="users-empty"
    style="text-align: center; padding: 2rem; display: none"
  >
    <p>No users found.</p>
  </div>
</main>

<!-- View User Modal -->
<div class="admin-modal-overlay" id="editUserModal">
  <div class="admin-modal" style="max-width: 500px">
    <div class="modal-header">
      <h3>View User</h3>
      <button class="modal-close" onclick="closeModal('editUserModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="edit-user-form">
        <input type="hidden" id="edit_user_id" />

        <div class="form-group">
          <label for="edit_user_name">Full Name</label>
          <input type="text" class="form-input" id="edit_user_name" disabled />
        </div>

        <div class="form-group">
          <label for="edit_user_email">Email</label>
          <input
            type="email"
            class="form-input"
            id="edit_user_email"
            disabled
          />
        </div>

        <div class="form-group">
          <label for="edit_user_phone">Phone Number</label>
          <input type="tel" class="form-input" id="edit_user_phone" disabled />
        </div>

        <div class="form-group">
          <label for="edit_user_address">Address</label>
          <input
            type="text"
            class="form-input"
            id="edit_user_address"
            disabled
          />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="edit_user_city">City</label>
            <input
              type="text"
              class="form-input"
              id="edit_user_city"
              disabled
            />
          </div>

          <div class="form-group">
            <label for="edit_user_postal">Postal Code</label>
            <input
              type="text"
              class="form-input"
              id="edit_user_postal"
              disabled
            />
          </div>
        </div>

        <div class="form-group">
          <label for="edit_user_role">Role</label>
          <input type="text" class="form-input" id="edit_user_role" disabled />
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Use window object to avoid redeclaration errors
  if (typeof window.allUsers === 'undefined') {
    window.allUsers = [];
  }
  if (typeof window.currentEditingUserId === 'undefined') {
    window.currentEditingUserId = null;
  }

  // Initialize if DOM is already loaded (happens when injected into existing page)
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initAdminUsersPage);
  } else {
    // DOM already loaded - page was dynamically injected
    // Initialize after a small delay to ensure elements are in DOM
    setTimeout(() => {
      initAdminUsersPage();
    }, 100);
  }

  function initAdminUsersPage() {
    loadUsers();

    // Edit user form
    const editForm = document.getElementById("edit-user-form");
    if (editForm) {
      editForm.addEventListener("submit", function (e) {
        e.preventDefault();
        saveUserChanges();
      });
    }
  }

  // Load all users from API
  function loadUsers() {
    const token = localStorage.getItem("user_token");
    if (!token) {
      showToast("Session expired. Please login again.", "error");
      return;
    }

    const loadingDiv = document.getElementById("users-loading");
    const emptyDiv = document.getElementById("users-empty");
    const usersGrid = document.getElementById("users-on-admin-dashboard");

    if (loadingDiv) loadingDiv.style.display = "block";
    if (emptyDiv) emptyDiv.style.display = "none";
    if (usersGrid) usersGrid.innerHTML = "";

    // Load only customers (non-admin users)
    fetch(Constants.get_api_base_url() + "users/customers?limit=100", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (!data) return;
        window.allUsers = Array.isArray(data) ? data : data.data || [];

        if (loadingDiv) loadingDiv.style.display = "none";

        if (window.allUsers.length === 0) {
          if (emptyDiv) emptyDiv.style.display = "block";
          return;
        }

        renderUsers(window.allUsers);
      })
      .catch((error) => {
        console.error("Error loading users:", error);
        if (loadingDiv) loadingDiv.style.display = "none";
        showToast("Error loading users. Please try again.", "error");
      });
  }

  // Render users in the grid
  function renderUsers(users) {
    const usersGrid = document.getElementById("users-on-admin-dashboard");
    usersGrid.innerHTML = "";

    users.forEach((user) => {
      const userCard = createUserCard(user);
      usersGrid.appendChild(userCard);
    });
  }

  // Create a user card element
  function createUserCard(user) {
    const col = document.createElement("div");
    col.className = "col-lg-4 col-md-6 mb-4";

    const isAdmin = user.role === "admin";
    const joinDate = user.created_at
      ? new Date(user.created_at).toLocaleDateString()
      : "N/A";

    col.innerHTML = `
      <div class="speaker">
        <div class="details">
          <h3>${user.full_name}</h3>
          <p><i class="fas fa-envelope"></i> ${user.email}</p>
          ${
            user.phone
              ? `<p><i class="fas fa-phone"></i> ${user.phone}</p>`
              : ""
          }
          ${
            user.address
              ? `<p><i class="fas fa-map-marker-alt"></i> ${user.address}</p>`
              : ""
          }
          <p><i class="fas fa-calendar"></i> Joined: ${joinDate}</p>
          ${
            isAdmin
              ? `<p><i class="fas fa-tag"></i> <span class="badge-admin">Administrator</span></p>`
              : ""
          }
          <div class="admin-actions">
            <button class="table-action-btn" onclick="editUser(${
              user.user_id
            })">
              <i class="fas fa-eye"></i> View
            </button>
          </div>
        </div>
      </div>
    `;

    return col;
  }

  // Open edit user modal
  function editUser(userId) {
    const user = window.allUsers.find((u) => u.user_id === userId);
    if (!user) {
      showToast("User not found", "error");
      return;
    }

    window.currentEditingUserId = userId;
    document.getElementById("edit_user_id").value = userId;
    document.getElementById("edit_user_name").value = user.full_name || "";
    document.getElementById("edit_user_email").value = user.email || "";
    document.getElementById("edit_user_phone").value = user.phone_number || "";
    document.getElementById("edit_user_address").value = user.address || "";
    document.getElementById("edit_user_city").value = user.city || "";
    document.getElementById("edit_user_postal").value = user.postal_code || "";
    document.getElementById("edit_user_role").value =
      user.role === "admin" ? "Administrator" : "Customer";

    openModal("editUserModal");
  }

  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add("active");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
    }
  }
</script>

<style>
  /* User Card Styles */
  .speaker {
    position: relative;
    overflow: hidden;
    margin-bottom: 30px;
    background: white;
    border-radius: 5px;
    box-shadow: 0px 2px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
    border: 1px solid var(--creme-dark);
  }

  .speaker:hover {
    transform: translateY(-10px);
    box-shadow: 0px 15px 30px rgba(0, 0, 0, 0.2);
  }

  .speaker .details {
    padding: 20px;
  }

  .speaker .details h3 {
    color: var(--burgundy-primary);
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 18px;
  }

  .speaker .details p {
    color: var(--medium-brown);
    margin-bottom: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .speaker .details p i {
    color: var(--burgundy-light);
    width: 16px;
  }

  .badge-admin {
    background-color: rgba(128, 0, 32, 0.1);
    color: var(--burgundy-primary);
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-pending {
    background-color: rgba(243, 156, 18, 0.1);
    color: #f39c12;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .speaker .admin-actions {
    margin-top: 15px;
    display: flex;
    gap: 0.5rem;
  }

  .speaker .admin-actions .table-action-btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 12px;
    text-align: center;
  }

  /* Grid Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }
</style>
