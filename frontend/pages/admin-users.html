<!-- ================= ADMIN USERS MANAGEMENT ================= -->
<main class="container page-container">
  <!-- Page Header with Back Button -->
  <div class="section-header" style="margin-bottom: 2rem">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      "
    >
      <div>
        <h1>User Information</h1>
        <p>Manage All Users</p>
      </div>
      <div style="display: flex; gap: 1rem">
        <button
          class="table-action-btn"
          onclick="openCreateUserModal()"
          style="background-color: #28a745; color: white"
        >
          <i class="fas fa-plus"></i> Add User
        </button>
        <button
          class="table-action-btn secondary"
          onclick="window.location.hash='admin-dashboard'"
        >
          <i class="fas fa-arrow-left"></i> Back to Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Users Grid -->
  <div class="row" id="users-on-admin-dashboard">
    <!-- Users will be loaded dynamically from API -->
  </div>

  <!-- Loading indicator -->
  <div id="users-loading" style="text-align: center; padding: 2rem">
    <p>Loading users...</p>
  </div>

  <!-- No users message -->
  <div
    id="users-empty"
    style="text-align: center; padding: 2rem; display: none"
  >
    <p>No users found.</p>
  </div>
</main>

<!-- Edit User Modal -->
<div class="admin-modal-overlay" id="editUserModal">
  <div class="admin-modal" style="max-width: 500px">
    <div class="modal-header">
      <h3>Edit User</h3>
      <button class="modal-close" onclick="closeModal('editUserModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="edit-user-form">
        <input type="hidden" id="edit_user_id" />

        <div class="form-group">
          <label for="edit_user_name">Full Name</label>
          <input type="text" class="form-input" id="edit_user_name" required />
        </div>

        <div class="form-group">
          <label for="edit_user_email">Email</label>
          <input
            type="email"
            class="form-input"
            id="edit_user_email"
            disabled
          />
        </div>

        <div class="form-group">
          <label for="edit_user_phone">Phone Number</label>
          <input type="tel" class="form-input" id="edit_user_phone" />
        </div>

        <div class="form-group">
          <label for="edit_user_address">Address</label>
          <input type="text" class="form-input" id="edit_user_address" />
        </div>

        <div class="form-row-2">
          <div class="form-group">
            <label for="edit_user_city">City</label>
            <input type="text" class="form-input" id="edit_user_city" />
          </div>

          <div class="form-group">
            <label for="edit_user_postal">Postal Code</label>
            <input type="text" class="form-input" id="edit_user_postal" />
          </div>
        </div>

        <div class="form-group">
          <label for="edit_user_role">Role</label>
          <select id="edit_user_role" class="form-input">
            <option value="customer">Customer</option>
            <option value="admin">Administrator</option>
          </select>
        </div>

        <div style="display: flex; gap: 1rem; margin-top: 1.5rem">
          <button type="submit" class="table-action-btn" style="flex: 1">
            <i class="fas fa-save"></i> Save Changes
          </button>
          <button
            type="button"
            class="table-action-btn secondary"
            onclick="deleteUserConfirm()"
            style="flex: 1"
          >
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Create User Modal -->
<div class="admin-modal-overlay" id="createUserModal">
  <div class="admin-modal" style="max-width: 500px">
    <div class="modal-header">
      <h3>Create New User</h3>
      <button class="modal-close" onclick="closeModal('createUserModal')">
        &times;
      </button>
    </div>
    <div class="modal-body">
      <form id="create-user-form">
        <div class="form-group">
          <label for="create_user_name">Full Name *</label>
          <input
            type="text"
            class="form-input"
            id="create_user_name"
            required
          />
        </div>

        <div class="form-group">
          <label for="create_user_email">Email *</label>
          <input
            type="email"
            class="form-input"
            id="create_user_email"
            required
          />
        </div>

        <div class="form-group">
          <label for="create_user_password">Password *</label>
          <input
            type="password"
            class="form-input"
            id="create_user_password"
            required
          />
        </div>

        <div class="form-group">
          <label for="create_user_phone">Phone Number</label>
          <input type="tel" class="form-input" id="create_user_phone" />
        </div>

        <div class="form-group">
          <label for="create_user_role">Role</label>
          <select id="create_user_role" class="form-input">
            <option value="customer">Customer</option>
            <option value="admin">Administrator</option>
          </select>
        </div>

        <button
          type="submit"
          class="table-action-btn"
          style="
            width: 100%;
            margin-top: 1rem;
            background-color: #28a745;
            color: white;
          "
        >
          <i class="fas fa-plus"></i> Create User
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  let allUsers = [];
  let currentEditingUserId = null;

  document.addEventListener("DOMContentLoaded", function () {
    console.log("Admin users page loaded");
    loadUsers();

    // Edit user form
    document
      .getElementById("edit-user-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        saveUserChanges();
      });

    // Create user form
    document
      .getElementById("create-user-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        createUser();
      });
  });

  // Load all users from API
  function loadUsers() {
    const token = localStorage.getItem("token");
    if (!token) {
      showToast("Session expired. Please login again.", "error");
      return;
    }

    const loadingDiv = document.getElementById("users-loading");
    const emptyDiv = document.getElementById("users-empty");
    const usersGrid = document.getElementById("users-on-admin-dashboard");

    loadingDiv.style.display = "block";
    emptyDiv.style.display = "none";
    usersGrid.innerHTML = "";

    fetch("http://localhost/diplomski/backend/api/users?limit=100", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (response.status === 401) {
          showToast("Unauthorized. Please login again.", "error");
          window.location.hash = "#login";
          return null;
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        if (!data) return;
        allUsers = Array.isArray(data) ? data : data.data || [];

        loadingDiv.style.display = "none";

        if (allUsers.length === 0) {
          emptyDiv.style.display = "block";
          return;
        }

        renderUsers(allUsers);
      })
      .catch((error) => {
        console.error("Error loading users:", error);
        loadingDiv.style.display = "none";
        showToast("Error loading users. Please try again.", "error");
      });
  }

  // Render users in the grid
  function renderUsers(users) {
    const usersGrid = document.getElementById("users-on-admin-dashboard");
    usersGrid.innerHTML = "";

    users.forEach((user) => {
      const userCard = createUserCard(user);
      usersGrid.appendChild(userCard);
    });
  }

  // Create a user card element
  function createUserCard(user) {
    const col = document.createElement("div");
    col.className = "col-lg-4 col-md-6 mb-4";

    const isAdmin = user.role === "admin";
    const joinDate = user.created_at
      ? new Date(user.created_at).toLocaleDateString()
      : "N/A";

    col.innerHTML = `
      <div class="speaker">
        <div class="details">
          <h3>${user.full_name}</h3>
          <p><i class="fas fa-envelope"></i> ${user.email}</p>
          ${
            user.phone
              ? `<p><i class="fas fa-phone"></i> ${user.phone}</p>`
              : ""
          }
          ${
            user.address
              ? `<p><i class="fas fa-map-marker-alt"></i> ${user.address}</p>`
              : ""
          }
          <p><i class="fas fa-calendar"></i> Joined: ${joinDate}</p>
          ${
            isAdmin
              ? `<p><i class="fas fa-tag"></i> <span class="badge-admin">Administrator</span></p>`
              : ""
          }
          <div class="admin-actions">
            <button class="table-action-btn" onclick="editUser(${user.id})">
              <i class="fas fa-edit"></i> Edit
            </button>
          </div>
        </div>
      </div>
    `;

    return col;
  }

  // Open edit user modal
  function editUser(userId) {
    const user = allUsers.find((u) => u.id === userId);
    if (!user) {
      showToast("User not found", "error");
      return;
    }

    currentEditingUserId = userId;
    document.getElementById("edit_user_id").value = userId;
    document.getElementById("edit_user_name").value = user.full_name || "";
    document.getElementById("edit_user_email").value = user.email || "";
    document.getElementById("edit_user_phone").value = user.phone || "";
    document.getElementById("edit_user_address").value = user.address || "";
    document.getElementById("edit_user_city").value = user.city || "";
    document.getElementById("edit_user_postal").value = user.postal_code || "";
    document.getElementById("edit_user_role").value = user.role || "customer";

    openModal("editUserModal");
  }

  // Save user changes
  function saveUserChanges() {
    const userId = document.getElementById("edit_user_id").value;
    const name = document.getElementById("edit_user_name").value.trim();
    const phone = document.getElementById("edit_user_phone").value.trim();
    const address = document.getElementById("edit_user_address").value.trim();
    const city = document.getElementById("edit_user_city").value.trim();
    const postal = document.getElementById("edit_user_postal").value.trim();
    const role = document.getElementById("edit_user_role").value;

    if (!name) {
      showToast("Full name is required", "error");
      return;
    }

    const token = localStorage.getItem("token");
    const updateData = {
      full_name: name,
      phone: phone,
      address: address,
      city: city,
      postal_code: postal,
    };

    showToast("Saving changes...", "info");

    // First update basic user info
    fetch(`http://localhost/diplomski/backend/api/users/${userId}`, {
      method: "PUT",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(updateData),
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        // Then update role if it changed
        const currentUser = allUsers.find((u) => u.id === parseInt(userId));
        if (currentUser.role !== role) {
          return fetch(
            `http://localhost/diplomski/backend/api/users/${userId}/role`,
            {
              method: "PUT",
              headers: {
                "Content-Type": "application/json",
                Authentication: token,
              },
              body: JSON.stringify({ role: role }),
            }
          ).then((response) => {
            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
          });
        }
        return data;
      })
      .then((data) => {
        showToast("User updated successfully!", "success");
        closeModal("editUserModal");
        loadUsers(); // Reload users
      })
      .catch((error) => {
        console.error("Error saving user:", error);
        showToast("Error saving user changes. Please try again.", "error");
      });
  }

  // Delete user confirmation
  function deleteUserConfirm() {
    const userId = document.getElementById("edit_user_id").value;
    const user = allUsers.find((u) => u.id === parseInt(userId));

    if (!user) {
      showToast("User not found", "error");
      return;
    }

    if (
      confirm(
        `Are you sure you want to delete ${user.full_name}? This action cannot be undone.`
      )
    ) {
      deleteUser(userId);
    }
  }

  // Delete user
  function deleteUser(userId) {
    const token = localStorage.getItem("token");

    showToast("Deleting user...", "info");

    fetch(`http://localhost/diplomski/backend/api/users/${userId}`, {
      method: "DELETE",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
    })
      .then((response) => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        showToast("User deleted successfully!", "success");
        closeModal("editUserModal");
        loadUsers(); // Reload users
      })
      .catch((error) => {
        console.error("Error deleting user:", error);
        showToast("Error deleting user. Please try again.", "error");
      });
  }

  // Open create user modal
  function openCreateUserModal() {
    document.getElementById("create-user-form").reset();
    openModal("createUserModal");
  }

  // Create new user
  function createUser() {
    const name = document.getElementById("create_user_name").value.trim();
    const email = document.getElementById("create_user_email").value.trim();
    const password = document.getElementById("create_user_password").value;
    const phone = document.getElementById("create_user_phone").value.trim();
    const role = document.getElementById("create_user_role").value;

    if (!name || !email || !password) {
      showToast("Name, email, and password are required", "error");
      return;
    }

    if (password.length < 6) {
      showToast("Password must be at least 6 characters", "error");
      return;
    }

    const token = localStorage.getItem("token");
    const userData = {
      full_name: name,
      email: email,
      password: password,
      phone: phone,
      role: role,
    };

    showToast("Creating user...", "info");

    fetch("http://localhost/diplomski/backend/api/users", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authentication: token,
      },
      body: JSON.stringify(userData),
    })
      .then((response) => {
        if (response.status === 400) {
          return response.json().then((data) => {
            throw new Error(data.error || "Error creating user");
          });
        }
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then((data) => {
        showToast("User created successfully!", "success");
        closeModal("createUserModal");
        loadUsers(); // Reload users
      })
      .catch((error) => {
        console.error("Error creating user:", error);
        showToast(
          error.message || "Error creating user. Please try again.",
          "error"
        );
      });
  }

  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.add("active");
    }
  }

  function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
      modal.classList.remove("active");
    }
  }
</script>

<style>
  /* User Card Styles */
  .speaker {
    position: relative;
    overflow: hidden;
    margin-bottom: 30px;
    background: white;
    border-radius: 5px;
    box-shadow: 0px 2px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease-in-out;
    border: 1px solid var(--creme-dark);
  }

  .speaker:hover {
    transform: translateY(-10px);
    box-shadow: 0px 15px 30px rgba(0, 0, 0, 0.2);
  }

  .speaker .details {
    padding: 20px;
  }

  .speaker .details h3 {
    color: var(--burgundy-primary);
    font-weight: 600;
    margin-bottom: 15px;
    font-size: 18px;
  }

  .speaker .details p {
    color: var(--medium-brown);
    margin-bottom: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .speaker .details p i {
    color: var(--burgundy-light);
    width: 16px;
  }

  .badge-admin {
    background-color: rgba(128, 0, 32, 0.1);
    color: var(--burgundy-primary);
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .badge-pending {
    background-color: rgba(243, 156, 18, 0.1);
    color: #f39c12;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .speaker .admin-actions {
    margin-top: 15px;
    display: flex;
    gap: 0.5rem;
  }

  .speaker .admin-actions .table-action-btn {
    flex: 1;
    padding: 0.5rem;
    font-size: 12px;
    text-align: center;
  }

  /* Grid Layout */
  .row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1.5rem;
  }

  /* Form Styles */
  .form-group {
    margin-bottom: 1rem;
  }

  .form-group label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--medium-brown);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 0.8rem;
    border: 1px solid var(--creme-dark);
    border-radius: 4px;
    background-color: white;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--burgundy-light);
  }
</style>
